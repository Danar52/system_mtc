<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Report Export - PT. Kunco</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ========================================
   PRODUCTION REPORT EXPORT - V4.1 FIXED
   A4 Landscape Optimized - PDF Ready
   ======================================== */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --color-primary: #1a1a1a;
    --color-border: #000000;
    --color-header-bg: #f5f5f5;
    --color-plan: #c6e0b4;
    --color-actual: #fce4d6;
    --color-loading: #dae3f3;
    --color-yellow: #ffeb9c;
    --color-blue: #4472c4;
    --font-family: "Plus Jakarta Sans", Arial, sans-serif;
}

body {
    font-family: var(--font-family);
    background: #f0f0f0;
    padding: 0;
    margin: 0;
}

/* ========================================
   ACTION BAR
   ======================================== */
.action-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
}

.action-left,
.action-right {
    display: flex;
    gap: 12px;
    align-items: center;
}

.btn-back,
.btn-export {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    font-family: var(--font-family);
    font-size: 14px;
    font-weight: 600;
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-back {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-color: rgba(255, 255, 255, 0.2);
}

.btn-back:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(-2px);
}

.btn-pdf {
    background: linear-gradient(135deg, #d32f2f 0%, #e57373 100%);
    color: white;
}

.btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn-export svg {
    width: 20px;
    height: 20px;
}

/* ========================================
   REPORT WRAPPER - A4 LANDSCAPE
   ======================================== */
.report-wrapper {
    padding-top: 90px;
    padding-bottom: 40px;
    display: flex;
    justify-content: center;
    min-height: 100vh;
}

.report-page {
    width: 297mm;
    min-height: 210mm;
    background: white;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    padding: 8mm;
    position: relative;
}

/* ========================================
   REPORT HEADER
   ======================================== */
.report-header {
    border: 2px solid var(--color-border);
    margin-bottom: 6px;
}

.header-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 10px;
    border-bottom: 2px solid var(--color-border);
}

.company-info h1 {
    font-size: 14px;
    font-weight: 800;
    color: var(--color-primary);
    line-height: 1.2;
    margin-bottom: 2px;
}

.company-info p {
    font-size: 9px;
    color: var(--color-primary);
    font-weight: 600;
}

.header-info {
    display: grid;
    grid-template-columns: 2fr 1fr;
}

.report-title {
    padding: 8px 10px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border-right: 2px solid var(--color-border);
}

.report-title h2 {
    font-size: 11px;
    font-weight: 800;
    text-align: center;
    color: var(--color-primary);
}

.report-meta {
    display: flex;
    flex-direction: column;
}

.meta-row {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    font-size: 8px;
    border-bottom: 1px solid var(--color-border);
}

.meta-row:last-child {
    border-bottom: none;
}

.meta-label {
    padding: 4px 8px;
    background: var(--color-header-bg);
    font-weight: 700;
    border-right: 1px solid var(--color-border);
    display: flex;
    align-items: center;
}

.meta-value {
    padding: 4px 8px;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.line-badge {
    grid-template-columns: 1fr;
    background: var(--color-yellow);
    display: flex;
    align-items: center;
    justify-content: center;
}

.badge-line {
    font-weight: 800;
    font-size: 10px;
    color: var(--color-primary);
}

/* ========================================
   MAIN TABLE
   ======================================== */
.report-body {
    margin-bottom: 6px;
}

.table-container {
    border: 2px solid var(--color-border);
    overflow-x: auto;
}

.report-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 7px;
    table-layout: auto;
}

.report-table th,
.report-table td {
    border: 1px solid var(--color-border);
    padding: 3px 4px;
    text-align: center;
    vertical-align: middle;
    line-height: 1.3;
    font-weight: 500;
}

.report-table thead th {
    background: var(--color-header-bg);
    font-weight: 700;
    font-size: 7px;
    color: var(--color-primary);
}

.report-table thead tr:first-child th {
    padding: 5px 3px;
    font-size: 7.5px;
}

.report-table thead tr:last-child th {
    padding: 4px 3px;
    font-size: 6.5px;
}

/* Section colors */
.section-plan {
    background: var(--color-plan) !important;
    font-weight: 700;
}

.section-actual {
    background: var(--color-actual) !important;
    font-weight: 700;
}

.section-loading {
    background: var(--color-loading) !important;
    font-weight: 700;
}

/* Column styling */
.report-table td.col-part-name {
    text-align: left;
    padding-left: 5px;
    font-weight: 600;
    min-width: 120px;
}

.report-table td.col-part-no {
    font-family: 'Courier New', monospace;
    font-size: 6.5px;
    min-width: 80px;
}

.report-table td.col-performance {
    font-weight: 700;
    font-size: 7.5px;
    min-width: 60px;
}

/* Performance colors */
.performance-excellent {
    background: #d4edda !important;
    color: #155724;
    font-weight: 700;
}

.performance-good {
    background: #fff3cd !important;
    color: #856404;
    font-weight: 700;
}

.performance-poor {
    background: #f8d7da !important;
    color: #721c24;
    font-weight: 700;
}

.report-table tbody tr:nth-child(even) {
    background: rgba(0, 0, 0, 0.02);
}

.machine-loading-cell {
    font-weight: 600;
    color: var(--color-blue);
}

.machine-loading-cell:not(:empty) {
    background: rgba(218, 227, 243, 0.4);
}

.table-loading,
.table-error {
    text-align: center !important;
    padding: 30px 20px !important;
    font-size: 10px;
    font-weight: 600;
}

.table-loading {
    color: #666;
    font-style: italic;
}

.table-error {
    color: #dc3545;
}

/* ========================================
   FOOTER SECTION
   ======================================== */
.report-footer {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 6px;
    border: 2px solid var(--color-border);
    padding: 6px;
    min-height: 120px;
}

.chart-section h3,
.summary-section h4 {
    font-size: 9px;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 4px;
    text-align: center;
}

.chart-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
    min-height: 100px;
}

.chart-wrapper canvas {
    max-height: 100px !important;
    width: 100% !important;
}

.summary-kapasitas {
    margin-bottom: 6px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--color-border);
}

.summary-kapasitas h4 {
    background: var(--color-yellow);
    padding: 4px;
    margin: 0 0 4px 0;
    border: 1px solid var(--color-border);
}

.kapasitas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 3px;
}

.kapasitas-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 5px;
    background: var(--color-header-bg);
    border: 1px solid var(--color-border);
    font-size: 7px;
}

.kapasitas-label {
    font-weight: 700;
}

.kapasitas-value {
    font-weight: 700;
    color: var(--color-blue);
}

.summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 7px;
}

.summary-table th,
.summary-table td {
    border: 1px solid var(--color-border);
    padding: 4px 5px;
    text-align: center;
}

.summary-table thead th {
    background: var(--color-header-bg);
    font-weight: 700;
}

.summary-table tbody td:first-child {
    text-align: left;
    font-weight: 600;
}

.summary-table tbody td:last-child {
    font-weight: 700;
    color: var(--color-blue);
}

/* ========================================
   ERROR & LOADING
   ======================================== */
.error-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center;
    z-index: 10000;
    max-width: 600px;
}

.error-message h3 {
    font-size: 24px;
    color: #dc3545;
    margin-bottom: 16px;
    font-weight: 700;
}

.error-message p {
    font-size: 14px;
    color: #666;
    margin-bottom: 24px;
    line-height: 1.6;
    white-space: pre-line;
}

.error-message button {
    padding: 12px 32px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-family: var(--font-family);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.error-message button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.loading-overlay.active {
    opacity: 1;
    visibility: visible;
}

.loading-spinner {
    text-align: center;
    color: white;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-spinner p {
    font-size: 16px;
    font-weight: 500;
}

/* ========================================
   RESPONSIVE
   ======================================== */
@media screen and (max-width: 1400px) {
    .report-page {
        width: 100%;
        max-width: 1200px;
    }
}

@media screen and (max-width: 768px) {
    .action-bar {
        flex-direction: column;
        height: auto;
        padding: 12px;
        gap: 8px;
    }
    
    .action-left,
    .action-right {
        width: 100%;
        justify-content: center;
    }
    
    .report-wrapper {
        padding-top: 160px;
    }
    
    .report-page {
        padding: 12px;
    }
    
    .report-footer {
        grid-template-columns: 1fr;
    }
}
    </style>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p id="loadingText">Loading report data...</p>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar" id="actionBar">
        <div class="action-left">
            <button class="btn-back" onclick="backToDashboard()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Back to Dashboard
            </button>
        </div>
        <div class="action-right">
            <button class="btn-export btn-pdf" onclick="exportToPDF()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M4 4C4 2.89543 4.89543 2 6 2H11L16 7V16C16 17.1046 15.1046 18 14 18H6C4.89543 18 4 17.1046 4 16V4Z" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M11 2V7H16" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                Download PDF
            </button>
        </div>
    </div>

    <!-- Report Container -->
    <div class="report-wrapper">
        <div class="report-page" id="reportContainer">
            <!-- Header -->
            <div class="report-header">
                <div class="header-logo">
                    <div class="logo-placeholder">
                        <svg width="180" height="32" viewBox="0 0 180 32" fill="none">
                            <rect width="180" height="32" fill="#1a1a1a" rx="4"/>
                            <text x="90" y="20" font-family="Arial" font-size="12" font-weight="bold" fill="white" text-anchor="middle">PT. KUNCO LOGO</text>
                        </svg>
                    </div>
                    <div class="company-info">
                        <h1>PT. KUNCO MANUFACTUR INDONESIA</h1>
                        <p>DIES, JIGS & PARTS MANUFACTURING</p>
                    </div>
                </div>
                <div class="header-info">
                    <div class="report-title">
                        <h2>SURAT PERINTAH KERJA PRODUKSI STAMPING</h2>
                    </div>
                    <div class="report-meta">
                        <div class="meta-row">
                            <span class="meta-label">HARI / TANGGAL</span>
                            <span class="meta-value" id="reportDate">-</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">NOMOR ACHIEVEMENT</span>
                            <span class="meta-value" id="achievementNo">-</span>
                        </div>
                        <div class="meta-row line-badge">
                            <span class="badge-line" id="lineName">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Table -->
            <div class="report-body">
                <div class="table-container">
                    <table class="report-table" id="reportTable">
                        <thead>
                            <tr>
                                <th rowspan="2">PART NAME</th>
                                <th rowspan="2">PART NO</th>
                                <th rowspan="2">ID<br>PROSES</th>
                                <th rowspan="2">PROSES</th>
                                <th rowspan="2">ID<br>MESIN</th>
                                <th rowspan="2">MESIN</th>
                                <th rowspan="2">SPH</th>
                                <th class="section-plan" rowspan="2">PLAN<br><br>QTY SPK</th>
                                <th colspan="7" class="section-actual">ACTUAL PRODUKSI</th>
                                <th rowspan="2">PERFORMANCE<br>SCORE</th>
                                <th colspan="1" class="section-loading" id="machineLoadingHeader">MACHINE LOADING</th>
                                <th rowspan="2">KODE<br>PROBLEM</th>
                            </tr>
                            <tr>
                                <th class="section-actual">QTY<br>PROD</th>
                                <th class="section-actual">ACTUAL<br>TIME</th>
                                <th class="section-actual">SPH<br>ACT</th>
                                <th class="section-actual">CYCLE<br>TIME</th>
                                <th class="section-actual">DAND<br>ORI</th>
                                <th class="section-actual">NEED<br>TIME</th>
                                <th class="section-actual">PROSES<br>TIME</th>
                                <th class="section-loading" id="machineHeaderRow"></th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr>
                                <td colspan="18" class="table-loading">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Footer -->
            <div class="report-footer">
                <div class="footer-left">
                    <div class="chart-section">
                        <h3>AVERAGE PERFORMANCE</h3>
                        <div class="chart-wrapper">
                            <canvas id="reportChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="footer-right">
                    <div class="summary-section">
                        <div class="summary-kapasitas">
                            <h4>KAPASITAS TERPAKAI</h4>
                            <div class="kapasitas-grid" id="kapasitasGrid">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                        <div class="summary-machines">
                            <table class="summary-table">
                                <thead>
                                    <tr>
                                        <th>MACHINE</th>
                                        <th>AVG PERF</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// ========================================
// PRODUCTION REPORT EXPORT - V4.1 FIXED
// FIELD MAPPING SYNCHRONIZED
// ========================================

let reportData = null;
let chartInstance = null;

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Production Report Export V4.1 - Field Mapping Fixed');
    loadReportData();
});

// ========================================
// LOAD REPORT DATA
// ========================================
function loadReportData() {
    showLoading('Loading report data...');
    
    try {
        const storedData = sessionStorage.getItem('reportData');
        
        if (!storedData) {
            throw new Error('No report data found!\n\nSilakan generate report dari dashboard terlebih dahulu.');
        }
        
        reportData = JSON.parse(storedData);
        console.log('üìä Report data loaded:', reportData);
        
        // Validate structure
        if (!validateReportData(reportData)) {
            throw new Error('Invalid report data structure!\n\nData tidak lengkap. Silakan regenerate report dari dashboard.');
        }
        
        // Render report
        renderReport();
        hideLoading();
        
    } catch (error) {
        console.error('‚ùå Load error:', error);
        hideLoading();
        showError(error.message);
    }
}

// ========================================
// VALIDATE DATA
// ========================================
function validateReportData(data) {
    if (!data) {
        console.error('‚ùå Data is null');
        return false;
    }
    
    if (!data.header || !data.header.dateFrom || !data.header.dateTo) {
        console.error('‚ùå Missing header data');
        return false;
    }
    
    if (!Array.isArray(data.records) || data.records.length === 0) {
        console.error('‚ùå Records invalid or empty');
        return false;
    }
    
    if (!Array.isArray(data.machines) || data.machines.length === 0) {
        console.error('‚ùå Machines invalid or empty');
        return false;
    }
    
    if (!data.chartData || !data.chartData.labels || !data.chartData.values) {
        console.error('‚ùå Chart data invalid');
        return false;
    }
    
    if (!data.summary) {
        console.error('‚ùå Summary data missing');
        return false;
    }
    
    console.log('‚úÖ Data validation passed');
    return true;
}

// ========================================
// RENDER REPORT
// ========================================
function renderReport() {
    try {
        console.log('üé® Rendering report components...');
        
        renderHeader();
        renderTable();
        renderChart();
        renderSummary();
        
        console.log('‚úÖ Report rendered successfully');
    } catch (error) {
        console.error('‚ùå Render error:', error);
        throw new Error('Failed to render report: ' + error.message);
    }
}

// ========================================
// RENDER HEADER
// ========================================
function renderHeader() {
    const { dateFrom, dateTo, achievementNo, lineName } = reportData.header;
    
    // Format date display
    let dateDisplay = '';
    if (dateFrom === dateTo) {
        const date = new Date(dateFrom);
        dateDisplay = date.toLocaleDateString('id-ID', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    } else {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);
        dateDisplay = `${from.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })} s/d ${to.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}`;
    }
    
    document.getElementById('reportDate').textContent = dateDisplay;
    document.getElementById('achievementNo').textContent = achievementNo || '-';
    document.getElementById('lineName').textContent = lineName || 'PRODUCTION LINE';
}

// ========================================
// RENDER TABLE
// ========================================
function renderTable() {
    const { records, machines } = reportData;
    const tbody = document.getElementById('reportTableBody');
    
    if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="18" class="table-error">No data available</td></tr>';
        return;
    }
    
    // Update machine headers
    updateMachineHeaders(machines);
    
    // Render rows
    const fragment = document.createDocumentFragment();
    
    records.forEach(record => {
        const row = createTableRow(record, machines);
        fragment.appendChild(row);
    });
    
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
    
    console.log(`‚úÖ Rendered ${records.length} records with ${machines.length} machines`);
}

// ========================================
// UPDATE MACHINE HEADERS
// ========================================
function updateMachineHeaders(machines) {
    const machineLoadingHeader = document.getElementById('machineLoadingHeader');
    const machineHeaderRow = document.getElementById('machineHeaderRow');
    
    if (!machineLoadingHeader || !machineHeaderRow) {
        console.warn('Machine header elements not found');
        return;
    }
    
    // Update colspan
    machineLoadingHeader.setAttribute('colspan', machines.length);
    
    // Clear existing machine headers
    const parent = machineHeaderRow.parentElement;
    const existingHeaders = parent.querySelectorAll('.section-loading:not(#machineLoadingHeader)');
    existingHeaders.forEach(h => h.remove());
    
    // Add new machine headers
    machines.forEach((machine, index) => {
        const th = document.createElement('th');
        th.className = 'section-loading';
        th.textContent = machine.shortName || machine.name || `M${index + 1}`;
        parent.insertBefore(th, machineHeaderRow);
    });
    
    machineHeaderRow.remove();
    
    console.log(`‚úÖ Machine headers updated: ${machines.length} columns`);
}

// ========================================
// CREATE TABLE ROW
// ========================================
function createTableRow(record, machines) {
    const tr = document.createElement('tr');
    
    // Parse performance score safely
    let perfScore = 0;
    if (record.performanceScore !== null && record.performanceScore !== undefined) {
        if (typeof record.performanceScore === 'string') {
            perfScore = parseFloat(record.performanceScore.replace('%', '').trim()) || 0;
        } else {
            perfScore = Number(record.performanceScore) || 0;
        }
    }
    
    const performanceClass = getPerformanceClass(perfScore);
    
    // Build row HTML
    let rowHtml = `
        <td class="col-part-name">${escapeHtml(record.partName || '')}</td>
        <td class="col-part-no">${escapeHtml(record.partNo || '')}</td>
        <td>${escapeHtml(record.idProses || '-')}</td>
        <td>${escapeHtml(record.proses || '')}</td>
        <td>${escapeHtml(record.idMesin || '-')}</td>
        <td>${escapeHtml(record.mesin || '')}</td>
        <td>${formatNumber(record.sph, 0)}</td>
        <td>${formatNumber(record.qtySpk, 0)}</td>
        <td>${formatNumber(record.qtyProd, 0)}</td>
        <td>${formatNumber(record.actTime, 2)}</td>
        <td>${formatNumber(record.sphAct, 0)}</td>
        <td>${formatNumber(record.cycleTime, 1)}</td>
        <td>${formatNumber(record.dandori, 0)}</td>
        <td>${formatNumber(record.needTime, 2)}</td>
        <td>${formatNumber(record.actTime, 2)}</td>
        <td class="col-performance ${performanceClass}">${formatNumber(perfScore, 1)}%</td>
    `;
    
    // Add machine loading cells
    machines.forEach(machine => {
        const machineKey = machine.name || machine.shortName;
        const value = record.machineLoading && record.machineLoading[machineKey] 
            ? Number(record.machineLoading[machineKey]) 
            : 0;
        const displayValue = value > 0 ? formatNumber(value, 2) : '';
        rowHtml += `<td class="machine-loading-cell">${displayValue}</td>`;
    });
    
    // Add problem code
    rowHtml += `<td>${escapeHtml(record.kodeProblem || '')}</td>`;
    
    tr.innerHTML = rowHtml;
    return tr;
}

// ========================================
// GET PERFORMANCE CLASS
// ========================================
function getPerformanceClass(score) {
    if (score >= 90) return 'performance-excellent';
    if (score >= 70) return 'performance-good';
    return 'performance-poor';
}

// ========================================
// RENDER CHART
// ========================================
function renderChart() {
    const { chartData } = reportData;
    
    const ctx = document.getElementById('reportChart');
    if (!ctx) {
        console.warn('Chart canvas not found');
        return;
    }
    
    // Destroy existing chart
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    
    // Generate colors based on performance
    const colors = chartData.values.map(value => {
        if (value >= 90) return '#10b981';
        if (value >= 70) return '#f59e0b';
        return '#ef4444';
    });
    
    // Create chart
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Performance (%)',
                data: chartData.values,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.5,
            plugins: {
                legend: { 
                    display: false 
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 10,
                    titleFont: { size: 11, weight: 'bold' },
                    bodyFont: { size: 10 },
                    callbacks: {
                        label: (context) => `Performance: ${context.parsed.y.toFixed(1)}%`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: (value) => value + '%',
                        font: { size: 9, weight: '600' }
                    },
                    grid: { 
                        color: 'rgba(0, 0, 0, 0.1)',
                        drawBorder: true
                    }
                },
                x: {
                    ticks: {
                        font: { size: 9, weight: 'bold' }
                    },
                    grid: { 
                        display: false 
                    }
                }
            }
        }
    });
    
    console.log('‚úÖ Chart rendered');
}

// ========================================
// RENDER SUMMARY
// ========================================
function renderSummary() {
    const { summary, machines } = reportData;
    
    // Kapasitas Terpakai
    const kapasitasGrid = document.getElementById('kapasitasGrid');
    if (kapasitasGrid && summary.kapasitasTerpakai) {
        const kapasitasHtml = machines.map((machine, index) => {
            const machineKey = machine.name || machine.shortName;
            const value = summary.kapasitasTerpakai[machineKey] || 0;
            return `
                <div class="kapasitas-item">
                    <span class="kapasitas-label">${machine.shortName || machine.name || `M${index + 1}`}</span>
                    <span class="kapasitas-value">${value > 0 ? formatNumber(value, 2) : '-'}</span>
                </div>
            `;
        }).join('');
        
        kapasitasGrid.innerHTML = kapasitasHtml;
    }
    
    // Machine Performance Summary
    const summaryTableBody = document.getElementById('summaryTableBody');
    if (summaryTableBody && summary.machinePerformance) {
        const tableHtml = summary.machinePerformance.map(item => {
            const perfValue = Number(item.avgPerformance) || 0;
            return `
                <tr>
                    <td>${escapeHtml(item.machine || '')}</td>
                    <td>${perfValue > 0 ? formatNumber(perfValue, 1) + '%' : '-'}</td>
                </tr>
            `;
        }).join('');
        
        summaryTableBody.innerHTML = tableHtml;
    }
    
    console.log('‚úÖ Summary rendered');
}

// ========================================
// EXPORT TO PDF - HIGH QUALITY
// ========================================
async function exportToPDF() {
    showLoading('Generating PDF...');
    
    try {
        console.log('üìÑ Starting PDF export...');
        
        // Hide action bar for clean export
        const actionBar = document.getElementById('actionBar');
        const originalDisplay = actionBar.style.display;
        actionBar.style.display = 'none';
        
        // Get report container
        const reportContainer = document.getElementById('reportContainer');
        
        // Capture as image with high quality
        const canvas = await html2canvas(reportContainer, {
            scale: 2, // Higher quality
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            windowWidth: 1122, // A4 landscape width in pixels (297mm)
            windowHeight: 794   // A4 landscape height in pixels (210mm)
        });
        
        // Restore action bar
        actionBar.style.display = originalDisplay;
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4',
            compress: true
        });
        
        // Calculate dimensions to fit A4
        const imgWidth = 297; // A4 landscape width in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // Add image to PDF
        const imgData = canvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight, '', 'FAST');
        
        // Generate filename
        const { dateFrom, dateTo, lineName } = reportData.header;
        const filename = `Production_Report_${lineName || 'LINE'}_${dateFrom}_${dateTo}.pdf`;
        
        // Save PDF
        pdf.save(filename);
        
        console.log('‚úÖ PDF exported:', filename);
        hideLoading();
        
    } catch (error) {
        console.error('‚ùå PDF export error:', error);
        hideLoading();
        alert('Error generating PDF: ' + error.message + '\n\nPlease try again or contact support.');
    }
}

// ========================================
// NAVIGATION
// ========================================
function backToDashboard() {
    // Cleanup
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    
    // Clear session data
    sessionStorage.removeItem('reportData');
    
    // Navigate back
    window.location.href = 'prod_dashb_achv.html';
}

// ========================================
// ERROR HANDLING
// ========================================
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `
        <h3>‚ö†Ô∏è Error</h3>
        <p>${escapeHtml(message)}</p>
        <button onclick="backToDashboard()">Back to Dashboard</button>
    `;
    document.body.appendChild(errorDiv);
}

// ========================================
// LOADING OVERLAY
// ========================================
function showLoading(message = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    if (loadingText) loadingText.textContent = message;
    if (overlay) overlay.classList.add('active');
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('active');
}

// ========================================
// UTILITY FUNCTIONS
// ========================================
function formatNumber(value, decimals = 0) {
    if (value === null || value === undefined || value === '' || isNaN(value)) {
        return '-';
    }
    return Number(value).toFixed(decimals);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

// ========================================
// CLEANUP ON EXIT
// ========================================
window.addEventListener('beforeunload', () => {
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
});

// Make functions globally accessible
window.backToDashboard = backToDashboard;
window.exportToPDF = exportToPDF;

console.log('‚úÖ Report Export Script V4.1 Loaded - Field Mapping Fixed');
    </script>
</body>
</html>