<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard VCB Dandori - Monitoring System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="assets/style/style_dashboard_dandori.css">
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="8" fill="white"/>
                            <path d="M16 8L8 12V20L16 24L24 20V12L16 8Z" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M16 16L8 12M16 16L24 12M16 16V24" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>VCB DANDORI</h1>
                        <p>Monitoring System</p>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="prod_inputdandori.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 3L3 7V13L10 17L17 13V7L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                    </svg>
                    <span>Input Data Dandori</span>
                </a>
                <a href="prod_vcbdandori.html" class="nav-item active">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="8" width="4" height="9" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="8" y="3" width="4" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="13" y="10" width="4" height="7" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="data_dandori.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M3 8H17M8 3V17" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Data Dandori</span>
                </a>
                <a href="index.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 17H16C16.5523 17 17 16.5523 17 16V4C17 3.44772 16.5523 3 16 3H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M8 13L3 10M3 10L8 7M3 10H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Kembali ke Menu</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <h2>Dashboard VCB Dandori</h2>
                    <p>Real-time dandori performance monitoring dan analytics</p>
                </div>
                <div class="header-right">
                    <div class="info-badge">
                        <span class="badge-label">Last Update:</span>
                        <span class="badge-value" id="lastUpdate">-</span>
                    </div>
                    <button class="btn-refresh" onclick="refreshData()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 9C15 12.3137 12.3137 15 9 15C5.68629 15 3 12.3137 3 9C3 5.68629 5.68629 3 9 3C10.6568 3 12.1569 3.67157 13.2426 4.75736" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M13 1V5H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-container">
                <div class="filter-header">
                    <h3>Filter Data</h3>
                    <button class="btn-reset-filter" onclick="resetAllFilters()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M5 8L7 10L11 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Reset Filter
                    </button>
                </div>
                <div class="filter-grid">
                    <div class="filter-field">
                        <label class="filter-label">Date Range</label>
                        <div class="date-range">
                            <input type="date" id="filterDateFrom" class="filter-input">
                            <span class="date-separator">to</span>
                            <input type="date" id="filterDateTo" class="filter-input">
                        </div>
                    </div>
                    <div class="filter-field">
                        <label class="filter-label">Machine</label>
                        <div class="searchable-dropdown" id="filterMesinDropdown">
                            <div class="search-input-wrapper">
                                <input 
                                    type="text" 
                                    id="filterMesin" 
                                    class="filter-input searchable-input" 
                                    placeholder="All machines..."
                                    autocomplete="off"
                                >
                                <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="7" cy="7" r="4" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M10 10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="dropdown-list" id="filterMesinList"></div>
                        </div>
                    </div>
                    <div class="filter-field">
                        <label class="filter-label">Part Name</label>
                        <div class="searchable-dropdown" id="filterPartDropdown">
                            <div class="search-input-wrapper">
                                <input 
                                    type="text" 
                                    id="filterPart" 
                                    class="filter-input searchable-input" 
                                    placeholder="All parts..."
                                    autocomplete="off"
                                >
                                <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="7" cy="7" r="4" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M10 10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="dropdown-list" id="filterPartList"></div>
                        </div>
                    </div>
                    <div class="filter-field">
                        <label class="filter-label" style="opacity: 0;">Apply</label>
                        <button class="btn-apply-filter" onclick="applyFilters()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 8L7 10L11 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Apply Filter
                        </button>
                    </div>
                </div>
                <div class="filter-info" id="filterInfo"></div>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-section">
                <div class="kpi-card">
                    <div class="kpi-icon blue">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 7V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">Average Time</div>
                        <div class="kpi-value"><span id="avgTime">-</span> <span class="kpi-unit">min</span></div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon green">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">On Time Rate</div>
                        <div class="kpi-value"><span id="onTimeRate">-</span> <span class="kpi-unit">%</span></div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon dark">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 12H16M12 8V16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">Total Dandori</div>
                        <div class="kpi-value"><span id="totalDandori">-</span> <span class="kpi-unit">activities</span></div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon red">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="12" cy="16" r="1" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">Total Delay</div>
                        <div class="kpi-value"><span id="totalDelay">-</span> <span class="kpi-unit">activities</span></div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Dandori Time Trend</h3>
                        <p>Average dandori time by date</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Performance by Machine</h3>
                        <p>Average time per machine</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="machineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-header-left">
                        <h3>Dandori Activities</h3>
                        <p>Latest dandori records</p>
                    </div>
                    <div class="table-header-right">
                        <select class="filter-select" id="filterStatus" onchange="filterTableByStatus()">
                            <option value="">All Status</option>
                            <option value="On Time">On Time</option>
                            <option value="Delay">Delay</option>
                            <option value="Cancel">Cancel</option>
                        </select>
                    </div>
                </div>

                <div id="tableLoading" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading data...</p>
                </div>

                <div class="table-wrapper">
                    <table id="dandoriTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Machine</th>
                                <th>Part Name</th>
                                <th>ID Proses</th>
                                <th>Nama Proses</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Duration</th>
                                <th>Standard</th>
                                <th>Status</th>
                                <th>PIC</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxEJ2R8WF2iKGjEM9fOKhwlXxquCUIZ9bzmvTtdrALw848aj-DCXIJUAQs95Zb60rJY/exec';

        let allData = [];
        let filteredData = [];
        let masterMesin = [];
        let masterPart = [];
        let selectedFilterMesin = null;
        let selectedFilterPart = null;

        let trendChart = null;
        let machineChart = null;

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            initializeDateFilter();
            attachFilterListeners();
            loadMasterData();
            refreshData();
        }

        function initializeDateFilter() {
            const today = new Date();
            const oneMonthAgo = new Date(today);
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            document.getElementById('filterDateFrom').valueAsDate = oneMonthAgo;
            document.getElementById('filterDateTo').valueAsDate = today;
        }

        function attachFilterListeners() {
            const filterMesin = document.getElementById('filterMesin');
            const filterPart = document.getElementById('filterPart');
            
            filterMesin.addEventListener('input', (e) => filterDropdown(e.target.value, 'mesin'));
            filterMesin.addEventListener('focus', () => showDropdown('mesin'));
            
            filterPart.addEventListener('input', (e) => filterDropdown(e.target.value, 'part'));
            filterPart.addEventListener('focus', () => showDropdown('part'));
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.searchable-dropdown')) {
                    hideAllDropdowns();
                }
            });
        }

        // ========================================
        // LOAD MASTER DATA
        // ========================================
        async function loadMasterData() {
            try {
                const mesinResponse = await fetch(`${API_URL}?action=getMasterMesin&_=${Date.now()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                const mesinData = await mesinResponse.json();
                
                if (mesinData.success) {
                    masterMesin = mesinData.data;
                    renderFilterMesinDropdown(masterMesin);
                }

                const diesResponse = await fetch(`${API_URL}?action=getMasterDies&_=${Date.now()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                const diesData = await diesResponse.json();
                
                if (diesData.success) {
                    masterPart = diesData.data;
                    renderFilterPartDropdown(masterPart);
                }
            } catch (error) {
                console.error('Error loading master data:', error);
            }
        }

        function renderFilterMesinDropdown(data) {
            const list = document.getElementById('filterMesinList');
            
            if (data.length === 0) {
                list.innerHTML = '<div class="dropdown-empty">Tidak ada mesin ditemukan</div>';
                return;
            }
            
            list.innerHTML = data.map(mesin => `
                <div class="dropdown-item" data-value="${mesin.nama_mesin}" data-mesin='${JSON.stringify(mesin)}'>
                    <div class="dropdown-item-title">${mesin.nama_mesin}</div>
                    <div class="dropdown-item-subtitle">Line: ${mesin.line}</div>
                </div>
            `).join('');
            
            list.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectFilterMesin(item));
            });
        }

        function renderFilterPartDropdown(data) {
            const list = document.getElementById('filterPartList');
            
            if (data.length === 0) {
                list.innerHTML = '<div class="dropdown-empty">Tidak ada part ditemukan</div>';
                return;
            }
            
            list.innerHTML = data.map(part => `
                <div class="dropdown-item" data-value="${part.part_name}" data-part='${JSON.stringify(part)}'>
                    <div class="dropdown-item-title">${part.part_name}</div>
                    <div class="dropdown-item-subtitle">Part No: ${part.part_no}</div>
                </div>
            `).join('');
            
            list.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectFilterPart(item));
            });
        }

        // ========================================
        // FILTER DROPDOWN LOGIC
        // ========================================
        function filterDropdown(query, type) {
            const data = type === 'mesin' ? masterMesin : masterPart;
            const searchField = type === 'mesin' ? 'nama_mesin' : 'part_name';
            
            const filtered = data.filter(item => 
                item[searchField].toLowerCase().includes(query.toLowerCase())
            );
            
            if (type === 'mesin') {
                renderFilterMesinDropdown(filtered);
            } else {
                renderFilterPartDropdown(filtered);
            }
            
            showDropdown(type);
        }

        function showDropdown(type) {
            const listId = type === 'mesin' ? 'filterMesinList' : 'filterPartList';
            document.getElementById(listId).classList.add('show');
        }

        function hideAllDropdowns() {
            document.getElementById('filterMesinList').classList.remove('show');
            document.getElementById('filterPartList').classList.remove('show');
        }

        function selectFilterMesin(item) {
            const mesinData = JSON.parse(item.dataset.mesin);
            selectedFilterMesin = mesinData.nama_mesin;
            document.getElementById('filterMesin').value = mesinData.nama_mesin;
            hideAllDropdowns();
        }

        function selectFilterPart(item) {
            const partData = JSON.parse(item.dataset.part);
            selectedFilterPart = partData.part_name;
            document.getElementById('filterPart').value = partData.part_name;
            hideAllDropdowns();
        }

        // ========================================
        // APPLY FILTERS
        // ========================================
        function applyFilters() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const mesin = document.getElementById('filterMesin').value.trim();
            const part = document.getElementById('filterPart').value.trim();
            
            filteredData = allData.filter(row => {
                let match = true;
                
                if (dateFrom && row.tanggal < dateFrom) match = false;
                if (dateTo && row.tanggal > dateTo) match = false;
                if (mesin && row.mesin !== mesin) match = false;
                if (part && row.part_name !== part) match = false;
                
                return match;
            });
            
            updateDashboard(filteredData);
            showFilterInfo(dateFrom, dateTo, mesin, part, filteredData.length);
        }

        function showFilterInfo(dateFrom, dateTo, mesin, part, resultCount) {
            const info = document.getElementById('filterInfo');
            
            let filterText = [];
            if (dateFrom || dateTo) {
                const from = dateFrom ? formatDate(dateFrom) : 'Start';
                const to = dateTo ? formatDate(dateTo) : 'Now';
                filterText.push(`Date: ${from} - ${to}`);
            }
            if (mesin) filterText.push(`Machine: ${mesin}`);
            if (part) filterText.push(`Part: ${part}`);
            
            if (filterText.length > 0) {
                info.innerHTML = `Showing ${resultCount} results | Filters: ${filterText.join(', ')}`;
                info.classList.add('show');
            } else {
                info.classList.remove('show');
            }
        }

        function resetAllFilters() {
            initializeDateFilter();
            document.getElementById('filterMesin').value = '';
            document.getElementById('filterPart').value = '';
            selectedFilterMesin = null;
            selectedFilterPart = null;
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterInfo').classList.remove('show');
            applyFilters();
        }

        // ========================================
        // REFRESH DATA
        // ========================================
        async function refreshData() {
            await loadDandoriData();
            applyFilters();
            updateLastUpdate();
        }

        async function loadDandoriData() {
            try {
                const response = await fetch(`${API_URL}?action=getDataDandori&_=${Date.now()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                const result = await response.json();

                if (result.success) {
                    allData = result.data;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('tableLoading').innerHTML = '<div class="loading-spinner"></div><p>Error loading data</p>';
            }
        }

        // ========================================
        // UPDATE DASHBOARD
        // ========================================
        function updateDashboard(data) {
            updateKPIs(data);
            populateTable(data);
            createCharts(data);
            
            document.getElementById('tableLoading').style.display = 'none';
            document.getElementById('dandoriTable').style.display = 'table';
        }

        function updateKPIs(data) {
            if (data.length === 0) {
                document.getElementById('avgTime').textContent = '0';
                document.getElementById('onTimeRate').textContent = '0';
                document.getElementById('totalDandori').textContent = '0';
                document.getElementById('totalDelay').textContent = '0';
                return;
            }
            
            const totalTime = data.reduce((sum, row) => sum + row.selisih_dandori, 0);
            const avgTime = Math.round(totalTime / data.length);
            
            const onTimeCount = data.filter(row => row.status === 'On Time').length;
            const onTimeRate = Math.round((onTimeCount / data.length) * 100);
            
            const delayCount = data.filter(row => row.status === 'Delay').length;
            
            document.getElementById('avgTime').textContent = avgTime;
            document.getElementById('onTimeRate').textContent = onTimeRate;
            document.getElementById('totalDandori').textContent = data.length;
            document.getElementById('totalDelay').textContent = delayCount;
        }

        // ========================================
        // CHARTS
        // ========================================
        function createCharts(data) {
            const trendData = prepareTrendData(data);
            createTrendChart(trendData);

            const machineData = prepareMachineData(data);
            createMachineChart(machineData);
        }

        function prepareTrendData(data) {
            if (data.length === 0) {
                return { labels: [], values: [] };
            }
            
            const dateGroups = {};
            
            data.forEach(row => {
                const dateStr = row.tanggal;
                if (!dateGroups[dateStr]) {
                    dateGroups[dateStr] = [];
                }
                dateGroups[dateStr].push(row.selisih_dandori);
            });

            const sortedDates = Object.keys(dateGroups).sort();
            const labels = [];
            const values = [];

            sortedDates.forEach(date => {
                const dd = new Date(date);
                labels.push(dd.getDate() + ' ' + dd.toLocaleDateString('id-ID', {month: 'short'}));
                
                const avg = dateGroups[date].reduce((a, b) => a + b, 0) / dateGroups[date].length;
                values.push(Math.round(avg));
            });

            return { labels, values };
        }

        function createTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Avg Dandori Time (min)',
                        data: data.values,
                        borderColor: '#000000',
                        backgroundColor: 'rgba(0, 0, 0, 0.05)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#000000',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#737373',
                                font: { family: 'Plus Jakarta Sans', size: 11 }
                            },
                            grid: { color: '#e5e5e5', drawBorder: false }
                        },
                        x: {
                            ticks: { 
                                color: '#737373',
                                font: { family: 'Plus Jakarta Sans', size: 11 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function prepareMachineData(data) {
            if (data.length === 0) {
                return { labels: [], values: [], colors: [] };
            }
            
            const machines = {};

            data.forEach(row => {
                if (!machines[row.mesin]) {
                    machines[row.mesin] = {
                        times: [],
                        standard: row.standard_dandori
                    };
                }
                machines[row.mesin].times.push(row.selisih_dandori);
            });

            const labels = [];
            const values = [];
            const colors = [];

            Object.keys(machines).forEach(mesin => {
                labels.push(mesin);
                const avg = machines[mesin].times.reduce((a, b) => a + b, 0) / machines[mesin].times.length;
                values.push(Math.round(avg));
                
                colors.push(avg <= machines[mesin].standard ? '#10b981' : '#ef4444');
            });

            return { labels, values, colors };
        }

        function createMachineChart(data) {
            const ctx = document.getElementById('machineChart').getContext('2d');
            
            if (machineChart) machineChart.destroy();

            machineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Avg Time (min)',
                        data: data.values,
                        backgroundColor: data.colors,
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#737373',
                                font: { family: 'Plus Jakarta Sans', size: 11 }
                            },
                            grid: { color: '#e5e5e5', drawBorder: false }
                        },
                        y: {
                            ticks: { 
                                color: '#737373',
                                font: { family: 'Plus Jakarta Sans', size: 11, weight: '600' }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ========================================
        // TABLE FUNCTIONS
        // ========================================
        function populateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--color-gray-500);">No data available</td></tr>';
                return;
            }

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                let statusClass = '';
                if (row.status === 'On Time') statusClass = 'status-ontime';
                else if (row.status === 'Delay') statusClass = 'status-delay';
                else if (row.status === 'Cancel') statusClass = 'status-cancel';

                const selisih = row.selisih_dandori - row.standard_dandori;
                const statusText = row.status === 'Delay' 
                    ? `Delay (+${selisih} min)` 
                    : row.status;

                const jamMulai = formatTimeFromSheet(row.jam_mulai_dandori);
                const jamSelesai = formatTimeFromSheet(row.jam_selesai_dandori);

                tr.innerHTML = `
                    <td>${formatDate(row.tanggal)}</td>
                    <td><strong>${row.mesin}</strong></td>
                    <td>${row.part_name}</td>
                    <td>${row.id_proses}</td>
                    <td>${row.nama_proses}</td>
                    <td>${jamMulai}</td>
                    <td>${jamSelesai}</td>
                    <td><strong>${row.selisih_dandori}</strong> min</td>
                    <td>${row.standard_dandori} min</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${row.pic_dandori}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterTableByStatus() {
            const filterStatus = document.getElementById('filterStatus').value;
            
            let dataToShow = filteredData.length > 0 ? filteredData : allData;
            
            if (filterStatus !== '') {
                dataToShow = dataToShow.filter(row => row.status === filterStatus);
            }
            
            populateTable(dataToShow);
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'short',
                year: 'numeric'
            });
        }

        function formatTimeFromSheet(timeStr) {
            if (!timeStr) return '-';
            
            if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}/.test(timeStr)) {
                return timeStr.substring(0, 5);
            }
            
            if (typeof timeStr === 'string' && timeStr.includes('T')) {
                const match = timeStr.match(/T(\d{2}):(\d{2})/);
                if (match) {
                    return `${match[1]}:${match[2]}`;
                }
            }
            
            return String(timeStr).substring(0, 5);
        }

        function updateLastUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = timeStr;
        }
    </script>
</body>
</html>