<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VCB Dandori</title>
    
    <!-- Google Fonts - Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- External CSS -->
    <!-- <link rel="stylesheet" href="style_dashboard.css"> -->
     <style>
        /* Root Variables */
:root {
    --color-primary: #1a1a1a;
    --color-secondary: #6b7280;
    --color-bg-primary: #ffffff;
    --color-bg-secondary: #f9fafb;
    --color-bg-tertiary: #f3f4f6;
    --color-border: #e5e7eb;
    --color-accent: #1a1a1a;
    --color-success: #10b981;
    --color-danger: #ef4444;
    --color-warning: #f59e0b;
    --color-info: #3b82f6;
    
    --spacing-xs: 0.5rem;
    --spacing-sm: 0.75rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    
    --radius-sm: 0.5rem;
    --radius-md: 0.75rem;
    --radius-lg: 1rem;
    
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--color-bg-primary);
    color: var(--color-primary);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Navigation */
.navbar {
    background-color: var(--color-bg-primary);
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing-md) 0;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.nav-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--spacing-xl);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-brand {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-primary);
}

.nav-brand i {
    font-size: 1.5rem;
}

.nav-menu {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    color: var(--color-secondary);
    text-decoration: none;
    border-radius: var(--radius-sm);
    font-weight: 500;
    transition: var(--transition);
    border: none;
    background: transparent;
    cursor: pointer;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.938rem;
}

.nav-link:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-primary);
}

.nav-link.active {
    background-color: var(--color-primary);
    color: var(--color-bg-primary);
}

.last-update {
    color: var(--color-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    padding: var(--spacing-xs) var(--spacing-sm);
    background-color: var(--color-bg-tertiary);
    border-radius: var(--radius-sm);
}

/* Main Content */
.main-content {
    padding: var(--spacing-xl) 0;
    background-color: var(--color-bg-secondary);
    min-height: calc(100vh - 80px);
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--spacing-xl);
}

/* Page Header */
.page-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
}

.page-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: var(--spacing-xs);
}

.page-subtitle {
    color: var(--color-secondary);
    font-size: 1rem;
    font-weight: 400;
}

/* Filter Section */
.filter-section {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.filter-title-wrapper {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.filter-title-wrapper i {
    font-size: 1.25rem;
    color: var(--color-secondary);
}

.filter-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-primary);
}

.btn-reset {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    background-color: transparent;
    color: var(--color-secondary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.btn-reset:hover {
    background-color: var(--color-bg-tertiary);
    border-color: var(--color-secondary);
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-lg);
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.filter-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.filter-input {
    padding: var(--spacing-sm) var(--spacing-md);
    background-color: var(--color-bg-primary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.938rem;
    transition: var(--transition);
}

.filter-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.05);
}

.date-range-wrapper {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.date-separator {
    color: var(--color-secondary);
    font-size: 0.875rem;
    font-weight: 500;
}

/* Searchable Dropdown */
.searchable-dropdown {
    position: relative;
    width: 100%;
}

.search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.search-input-wrapper i {
    position: absolute;
    left: var(--spacing-md);
    color: var(--color-secondary);
    pointer-events: none;
}

.searchable-input {
    width: 100%;
    padding: var(--spacing-sm) var(--spacing-md) var(--spacing-sm) 2.5rem;
    background-color: var(--color-bg-primary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.938rem;
    transition: var(--transition);
}

.searchable-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.05);
}

.searchable-input::placeholder {
    color: var(--color-secondary);
}

.dropdown-list {
    position: absolute;
    top: calc(100% + 0.25rem);
    left: 0;
    right: 0;
    max-height: 200px;
    overflow-y: auto;
    background-color: var(--color-bg-primary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: none;
}

.dropdown-list.show {
    display: block;
}

.dropdown-item {
    padding: var(--spacing-sm) var(--spacing-md);
    cursor: pointer;
    transition: var(--transition);
    border-bottom: 1px solid var(--color-bg-tertiary);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item:hover {
    background-color: var(--color-bg-tertiary);
}

.dropdown-item.active {
    background-color: var(--color-primary);
    color: var(--color-bg-primary);
}

.dropdown-empty {
    padding: var(--spacing-md);
    text-align: center;
    color: var(--color-secondary);
    font-size: 0.875rem;
}

.btn-apply {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    background-color: var(--color-primary);
    color: var(--color-bg-primary);
    border: none;
    border-radius: var(--radius-sm);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.938rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.btn-apply:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(26, 26, 26, 0.15);
}

.filter-info {
    margin-top: var(--spacing-md);
    padding: var(--spacing-sm) var(--spacing-md);
    background-color: var(--color-bg-tertiary);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    color: var(--color-secondary);
    display: none;
}

.filter-info.show {
    display: block;
}

/* KPI Cards */
.kpi-section {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.kpi-card {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background-color: var(--color-primary);
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.kpi-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-sm);
}

.kpi-icon {
    width: 40px;
    height: 40px;
    background-color: var(--color-bg-tertiary);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.kpi-label {
    color: var(--color-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: var(--spacing-xs);
}

.kpi-unit {
    color: var(--color-secondary);
    font-size: 0.875rem;
    font-weight: 500;
}

/* Charts Section */
.charts-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.chart-card {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.chart-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.chart-header i {
    font-size: 1.25rem;
    color: var(--color-secondary);
}

.chart-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-primary);
}

.chart-container {
    position: relative;
    height: 300px;
}

/* Table Section - Optimized Size */
.table-section {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.table-title-wrapper {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.table-title-wrapper i {
    font-size: 1.125rem;
    color: var(--color-secondary);
}

.table-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-primary);
}

.table-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.filter-select {
    padding: var(--spacing-xs) var(--spacing-sm);
    background-color: var(--color-bg-primary);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-primary);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.813rem;
    font-weight: 500;
    transition: var(--transition);
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.05);
}

.table-wrapper {
    overflow-x: auto;
}

/* Table - Smaller & No Wrap */
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.813rem; /* Smaller font */
}

thead {
    background-color: var(--color-bg-tertiary);
}

th {
    padding: var(--spacing-sm) var(--spacing-sm);
    text-align: left;
    color: var(--color-primary);
    font-weight: 600;
    font-size: 0.75rem; /* Smaller header */
    text-transform: uppercase;
    letter-spacing: 0.025em;
    border-bottom: 2px solid var(--color-border);
    white-space: nowrap; /* No wrap */
}

td {
    padding: var(--spacing-sm) var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
    font-size: 0.813rem; /* Smaller text */
    white-space: nowrap; /* No wrap */
    vertical-align: middle;
}

/* Strong text in table - slightly smaller */
td strong {
    font-weight: 600;
    font-size: 0.813rem;
}

tbody tr {
    transition: var(--transition);
}

tbody tr:hover {
    background-color: var(--color-bg-tertiary);
}

/* Status Badge - Compact */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem; /* Smaller badge */
    font-weight: 600;
    white-space: nowrap;
}

.status-badge i {
    font-size: 0.75rem;
}

.status-ontime {
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--color-success);
    border: 1px solid var(--color-success);
}

.status-delay {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--color-danger);
    border: 1px solid var(--color-danger);
}

.status-cancel {
    background-color: rgba(107, 114, 128, 0.1);
    color: var(--color-secondary);
    border: 1px solid var(--color-secondary);
}

/* Loading */
.loading {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--color-secondary);
    font-weight: 500;
    font-size: 0.875rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--spacing-md);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .table-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-md);
    }

    .table-wrapper {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
    }

    table {
        font-size: 0.75rem;
        min-width: 800px; /* Prevent table from being too narrow */
    }

    th {
        padding: var(--spacing-xs);
        font-size: 0.688rem;
    }

    td {
        padding: var(--spacing-xs);
        font-size: 0.75rem;
    }

    .status-badge {
        font-size: 0.688rem;
        padding: 0.188rem 0.375rem;
    }
}
     </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="bi bi-clipboard-data"></i>
                <span>VCB Dandori System</span>
            </div>
            <div class="nav-menu">
                <span class="last-update" id="lastUpdate">Last update: -</span>
                <a href="vcb_dandori.html" class="nav-link active">
                    <i class="bi bi-graph-up"></i>
                    <span>Dashboard</span>
                </a>
                <a href="input_dandori.html" class="nav-link">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>Data Input</span>
                </a>
                <button class="nav-link" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="bi bi-speedometer2"></i>
                    Visual Control System - Dandori
                </h1>
                <p class="page-subtitle">Real-time dandori performance monitoring</p>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <div class="filter-header">
                    <div class="filter-title-wrapper">
                        <i class="bi bi-funnel"></i>
                        <h3 class="filter-title">Data Filter</h3>
                    </div>
                    <button class="btn-reset" onclick="resetAllFilters()">
                        <i class="bi bi-x-circle"></i>
                        Reset Filter
                    </button>
                </div>

                <div class="filter-grid">
                    <!-- Date Range Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-calendar-range"></i>
                            Date Range
                        </label>
                        <div class="date-range-wrapper">
                            <input type="date" id="filterDateFrom" class="filter-input">
                            <span class="date-separator">to</span>
                            <input type="date" id="filterDateTo" class="filter-input">
                        </div>
                    </div>

                    <!-- Machine Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-cpu"></i>
                            Machine
                        </label>
                        <div class="searchable-dropdown" id="filterMesinDropdown">
                            <div class="search-input-wrapper">
                                <i class="bi bi-search"></i>
                                <input 
                                    type="text" 
                                    id="filterMesin" 
                                    class="searchable-input" 
                                    placeholder="All machines..."
                                    autocomplete="off"
                                >
                            </div>
                            <div class="dropdown-list" id="filterMesinList"></div>
                        </div>
                    </div>

                    <!-- Part Name Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-box-seam"></i>
                            Part Name
                        </label>
                        <div class="searchable-dropdown" id="filterPartDropdown">
                            <div class="search-input-wrapper">
                                <i class="bi bi-search"></i>
                                <input 
                                    type="text" 
                                    id="filterPart" 
                                    class="searchable-input" 
                                    placeholder="All parts..."
                                    autocomplete="off"
                                >
                            </div>
                            <div class="dropdown-list" id="filterPartList"></div>
                        </div>
                    </div>

                    <!-- Apply Button -->
                    <div class="filter-group">
                        <label class="filter-label" style="visibility: hidden;">Apply</label>
                        <button class="btn-apply" onclick="applyFilters()">
                            <i class="bi bi-check-circle"></i>
                            Apply Filter
                        </button>
                    </div>
                </div>

                <div class="filter-info" id="filterInfo"></div>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-section">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-clock-history" style="color: var(--color-info);"></i>
                        </div>
                        <div class="kpi-label">Average Time</div>
                    </div>
                    <div class="kpi-value" id="avgTime">-</div>
                    <div class="kpi-unit">minutes</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-check-circle" style="color: var(--color-success);"></i>
                        </div>
                        <div class="kpi-label">On Time Rate</div>
                    </div>
                    <div class="kpi-value" id="onTimeRate">-</div>
                    <div class="kpi-unit">%</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-list-check" style="color: var(--color-primary);"></i>
                        </div>
                        <div class="kpi-label">Total Dandori</div>
                    </div>
                    <div class="kpi-value" id="totalDandori">-</div>
                    <div class="kpi-unit">activities</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-exclamation-circle" style="color: var(--color-danger);"></i>
                        </div>
                        <div class="kpi-label">Total Delay</div>
                    </div>
                    <div class="kpi-value" id="totalDelay">-</div>
                    <div class="kpi-unit">activities</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <i class="bi bi-graph-up-arrow"></i>
                        <h3 class="chart-title">Dandori Time Trend</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <i class="bi bi-bar-chart"></i>
                        <h3 class="chart-title">Performance by Machine</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="machineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Latest Activities Table -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title-wrapper">
                        <i class="bi bi-table"></i>
                        <h3 class="table-title">Dandori Activities</h3>
                    </div>
                    <div class="table-actions">
                        <select class="filter-select" id="filterStatus" onchange="filterTableByStatus()">
                            <option value="">All Status</option>
                            <option value="On Time">On Time</option>
                            <option value="Delay">Delay</option>
                            <option value="Cancel">Cancel</option>
                        </select>
                    </div>
                </div>

                <div id="tableLoading" class="loading">
                    <div class="loading-spinner"></div>
                    Loading data...
                </div>

                <div class="table-wrapper">
                    <table id="dandoriTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Machine</th>
                                <th>Part Name</th>
                                <th>ID Proses</th>
                                <th>Nama Proses</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Duration</th>
                                <th>Standard</th>
                                <th>Status</th>
                                <th>PIC</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- External JavaScript -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxEJ2R8WF2iKGjEM9fOKhwlXxquCUIZ9bzmvTtdrALw848aj-DCXIJUAQs95Zb60rJY/exec';

let allData = [];
let filteredData = [];
let masterMesin = [];
let masterPart = [];
let selectedFilterMesin = null;
let selectedFilterPart = null;

let trendChart = null;
let machineChart = null;

// Initialize
window.addEventListener('DOMContentLoaded', () => {
    initializeDateFilter();
    loadMasterData();
    attachFilterListeners();
    refreshData();
});

// ============================================
// INITIALIZATION
// ============================================

function initializeDateFilter() {
    const today = new Date();
    const oneMonthAgo = new Date(today);
    oneMonthAgo.setMonth(today.getMonth() - 1);
    
    document.getElementById('filterDateFrom').valueAsDate = oneMonthAgo;
    document.getElementById('filterDateTo').valueAsDate = today;
}

function attachFilterListeners() {
    const filterMesin = document.getElementById('filterMesin');
    const filterPart = document.getElementById('filterPart');
    
    filterMesin.addEventListener('input', (e) => filterDropdown(e.target.value, 'mesin'));
    filterMesin.addEventListener('focus', () => showDropdown('mesin'));
    
    filterPart.addEventListener('input', (e) => filterDropdown(e.target.value, 'part'));
    filterPart.addEventListener('focus', () => showDropdown('part'));
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.searchable-dropdown')) {
            hideAllDropdowns();
        }
    });
}

// ============================================
// LOAD MASTER DATA
// ============================================

async function loadMasterData() {
    try {
        // Load Master Mesin
        const mesinResponse = await fetch(`${API_URL}?action=getMasterMesin`);
        const mesinData = await mesinResponse.json();
        
        if (mesinData.success) {
            masterMesin = mesinData.data;
            renderFilterMesinDropdown(masterMesin);
        }

        // Load Master Dies (Part)
        const diesResponse = await fetch(`${API_URL}?action=getMasterDies`);
        const diesData = await diesResponse.json();
        
        if (diesData.success) {
            masterPart = diesData.data;
            renderFilterPartDropdown(masterPart);
        }
    } catch (error) {
        console.error('Error loading master data:', error);
    }
}

// ============================================
// RENDER FILTER DROPDOWNS
// ============================================

function renderFilterMesinDropdown(data) {
    const list = document.getElementById('filterMesinList');
    
    if (data.length === 0) {
        list.innerHTML = '<div class="dropdown-empty">No machine found</div>';
        return;
    }
    
    list.innerHTML = data.map(mesin => `
        <div class="dropdown-item" data-value="${mesin.nama_mesin}" data-mesin='${JSON.stringify(mesin)}'>
            <strong>${mesin.nama_mesin}</strong>
            <div style="font-size: 0.813rem; color: var(--color-secondary);">
                Line: ${mesin.line}
            </div>
        </div>
    `).join('');
    
    list.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', () => selectFilterMesin(item));
    });
}

function renderFilterPartDropdown(data) {
    const list = document.getElementById('filterPartList');
    
    if (data.length === 0) {
        list.innerHTML = '<div class="dropdown-empty">No part found</div>';
        return;
    }
    
    list.innerHTML = data.map(part => `
        <div class="dropdown-item" data-value="${part.part_name}" data-part='${JSON.stringify(part)}'>
            <strong>${part.part_name}</strong>
            <div style="font-size: 0.813rem; color: var(--color-secondary);">
                Part No: ${part.part_no}
            </div>
        </div>
    `).join('');
    
    list.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', () => selectFilterPart(item));
    });
}

// ============================================
// FILTER DROPDOWN LOGIC
// ============================================

function filterDropdown(query, type) {
    const data = type === 'mesin' ? masterMesin : masterPart;
    const searchField = type === 'mesin' ? 'nama_mesin' : 'part_name';
    
    const filtered = data.filter(item => 
        item[searchField].toLowerCase().includes(query.toLowerCase())
    );
    
    if (type === 'mesin') {
        renderFilterMesinDropdown(filtered);
    } else {
        renderFilterPartDropdown(filtered);
    }
    
    showDropdown(type);
}

function showDropdown(type) {
    const listId = type === 'mesin' ? 'filterMesinList' : 'filterPartList';
    document.getElementById(listId).classList.add('show');
}

function hideAllDropdowns() {
    document.getElementById('filterMesinList').classList.remove('show');
    document.getElementById('filterPartList').classList.remove('show');
}

function selectFilterMesin(item) {
    const mesinData = JSON.parse(item.dataset.mesin);
    selectedFilterMesin = mesinData.nama_mesin;
    document.getElementById('filterMesin').value = mesinData.nama_mesin;
    hideAllDropdowns();
}

function selectFilterPart(item) {
    const partData = JSON.parse(item.dataset.part);
    selectedFilterPart = partData.part_name;
    document.getElementById('filterPart').value = partData.part_name;
    hideAllDropdowns();
}

// ============================================
// APPLY FILTERS
// ============================================

function applyFilters() {
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const mesin = document.getElementById('filterMesin').value.trim();
    const part = document.getElementById('filterPart').value.trim();
    
    // Filter data
    filteredData = allData.filter(row => {
        let match = true;
        
        // Filter by date range
        if (dateFrom && row.tanggal < dateFrom) match = false;
        if (dateTo && row.tanggal > dateTo) match = false;
        
        // Filter by machine
        if (mesin && row.mesin !== mesin) match = false;
        
        // Filter by part
        if (part && row.part_name !== part) match = false;
        
        return match;
    });
    
    // Update UI
    updateDashboard(filteredData);
    showFilterInfo(dateFrom, dateTo, mesin, part, filteredData.length);
}

function showFilterInfo(dateFrom, dateTo, mesin, part, resultCount) {
    const info = document.getElementById('filterInfo');
    
    let filterText = [];
    if (dateFrom || dateTo) {
        const from = dateFrom ? formatDate(dateFrom) : 'Start';
        const to = dateTo ? formatDate(dateTo) : 'Now';
        filterText.push(`Date: ${from} - ${to}`);
    }
    if (mesin) filterText.push(`Machine: ${mesin}`);
    if (part) filterText.push(`Part: ${part}`);
    
    if (filterText.length > 0) {
        info.innerHTML = `<i class="bi bi-info-circle"></i> Showing ${resultCount} results | Filters: ${filterText.join(', ')}`;
        info.classList.add('show');
    } else {
        info.classList.remove('show');
    }
}

function resetAllFilters() {
    // Reset date to last 1 month
    initializeDateFilter();
    
    // Reset dropdowns
    document.getElementById('filterMesin').value = '';
    document.getElementById('filterPart').value = '';
    selectedFilterMesin = null;
    selectedFilterPart = null;
    
    // Reset status filter
    document.getElementById('filterStatus').value = '';
    
    // Hide filter info
    document.getElementById('filterInfo').classList.remove('show');
    
    // Reload data with default filters
    applyFilters();
}

// ============================================
// REFRESH DATA
// ============================================

async function refreshData() {
    await loadDandoriData();
    applyFilters();
    updateLastUpdate();
}

async function loadDandoriData() {
    try {
        const response = await fetch(`${API_URL}?action=getDataDandori`);
        const result = await response.json();

        if (result.success) {
            allData = result.data;
        }
    } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('tableLoading').innerHTML = '<div class="loading-spinner"></div>Error loading data';
    }
}

// ============================================
// UPDATE DASHBOARD
// ============================================

function updateDashboard(data) {
    updateKPIs(data);
    populateTable(data);
    createCharts(data);
    
    // Show table
    document.getElementById('tableLoading').style.display = 'none';
    document.getElementById('dandoriTable').style.display = 'table';
}

function updateKPIs(data) {
    if (data.length === 0) {
        document.getElementById('avgTime').textContent = '0';
        document.getElementById('onTimeRate').textContent = '0';
        document.getElementById('totalDandori').textContent = '0';
        document.getElementById('totalDelay').textContent = '0';
        return;
    }
    
    // Calculate average time
    const totalTime = data.reduce((sum, row) => sum + row.selisih_dandori, 0);
    const avgTime = Math.round(totalTime / data.length);
    
    // Calculate on time rate
    const onTimeCount = data.filter(row => row.status === 'On Time').length;
    const onTimeRate = Math.round((onTimeCount / data.length) * 100);
    
    // Count delays
    const delayCount = data.filter(row => row.status === 'Delay').length;
    
    // Update KPIs
    document.getElementById('avgTime').textContent = avgTime;
    document.getElementById('onTimeRate').textContent = onTimeRate;
    document.getElementById('totalDandori').textContent = data.length;
    document.getElementById('totalDelay').textContent = delayCount;
}

// ============================================
// CHARTS
// ============================================

function createCharts(data) {
    const trendData = prepareTrendData(data);
    createTrendChart(trendData);

    const machineData = prepareMachineData(data);
    createMachineChart(machineData);
}

function prepareTrendData(data) {
    if (data.length === 0) {
        return { labels: [], values: [] };
    }
    
    // Group by date
    const dateGroups = {};
    
    data.forEach(row => {
        const dateStr = row.tanggal;
        if (!dateGroups[dateStr]) {
            dateGroups[dateStr] = [];
        }
        dateGroups[dateStr].push(row.selisih_dandori);
    });

    // Sort dates and calculate averages
    const sortedDates = Object.keys(dateGroups).sort();
    const labels = [];
    const values = [];

    sortedDates.forEach(date => {
        const dd = new Date(date);
        labels.push(dd.getDate() + ' ' + dd.toLocaleDateString('id-ID', {month: 'short'}));
        
        const avg = dateGroups[date].reduce((a, b) => a + b, 0) / dateGroups[date].length;
        values.push(Math.round(avg));
    });

    return { labels, values };
}

function createTrendChart(data) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    if (trendChart) trendChart.destroy();

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Avg Dandori Time (min)',
                data: data.values,
                borderColor: '#1a1a1a',
                backgroundColor: 'rgba(26, 26, 26, 0.05)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: '#1a1a1a',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { 
                        color: '#6b7280',
                        font: {
                            family: 'Plus Jakarta Sans',
                            size: 11
                        }
                    },
                    grid: { 
                        color: '#e5e7eb',
                        drawBorder: false
                    }
                },
                x: {
                    ticks: { 
                        color: '#6b7280',
                        font: {
                            family: 'Plus Jakarta Sans',
                            size: 11
                        }
                    },
                    grid: { 
                        display: false
                    }
                }
            }
        }
    });
}

function prepareMachineData(data) {
    if (data.length === 0) {
        return { labels: [], values: [], colors: [] };
    }
    
    const machines = {};

    data.forEach(row => {
        if (!machines[row.mesin]) {
            machines[row.mesin] = {
                times: [],
                standard: row.standard_dandori
            };
        }
        machines[row.mesin].times.push(row.selisih_dandori);
    });

    const labels = [];
    const values = [];
    const colors = [];

    Object.keys(machines).forEach(mesin => {
        labels.push(mesin);
        const avg = machines[mesin].times.reduce((a, b) => a + b, 0) / machines[mesin].times.length;
        values.push(Math.round(avg));
        
        colors.push(avg <= machines[mesin].standard ? '#10b981' : '#ef4444');
    });

    return { labels, values, colors };
}

function createMachineChart(data) {
    const ctx = document.getElementById('machineChart').getContext('2d');
    
    if (machineChart) machineChart.destroy();

    machineChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Avg Time (min)',
                data: data.values,
                backgroundColor: data.colors,
                borderRadius: 6,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { 
                        color: '#6b7280',
                        font: {
                            family: 'Plus Jakarta Sans',
                            size: 11
                        }
                    },
                    grid: { 
                        color: '#e5e7eb',
                        drawBorder: false
                    }
                },
                y: {
                    ticks: { 
                        color: '#6b7280',
                        font: {
                            family: 'Plus Jakarta Sans',
                            size: 11,
                            weight: '600'
                        }
                    },
                    grid: { 
                        display: false
                    }
                }
            }
        }
    });
}

// ============================================
// TABLE FUNCTIONS
// ============================================

function populateTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--color-secondary);">No data available</td></tr>';
        return;
    }

    data.forEach(row => {
        const tr = document.createElement('tr');
        
        let statusClass = '';
        if (row.status === 'On Time') statusClass = 'status-ontime';
        else if (row.status === 'Delay') statusClass = 'status-delay';
        else if (row.status === 'Cancel') statusClass = 'status-cancel';

        const selisih = row.selisih_dandori - row.standard_dandori;
        const statusText = row.status === 'Delay' 
            ? `Delay (+${selisih} min)` 
            : row.status;
        
        const statusIcon = row.status === 'On Time' ? 'bi-check-circle' : 
                          row.status === 'Delay' ? 'bi-exclamation-circle' : 'bi-x-circle';

        // ✅ FIX: Format time dengan timezone Indonesia
        const jamMulai = formatTimeFromSheet(row.jam_mulai_dandori);
        const jamSelesai = formatTimeFromSheet(row.jam_selesai_dandori);

        tr.innerHTML = `
            <td>${formatDate(row.tanggal)}</td>
            <td><strong>${row.mesin}</strong></td>
            <td>${row.part_name}</td>
            <td>${row.id_proses}</td>
            <td>${row.nama_proses}</td>
            <td>${jamMulai}</td>
            <td>${jamSelesai}</td>
            <td><strong>${row.selisih_dandori}</strong> min</td>
            <td>${row.standard_dandori} min</td>
            <td><span class="status-badge ${statusClass}"><i class="bi ${statusIcon}"></i>${statusText}</span></td>
            <td>${row.pic_dandori}</td>
        `;
        tbody.appendChild(tr);
    });
}

function filterTableByStatus() {
    const filterStatus = document.getElementById('filterStatus').value;
    
    let dataToShow = filteredData.length > 0 ? filteredData : allData;
    
    if (filterStatus !== '') {
        dataToShow = dataToShow.filter(row => row.status === filterStatus);
    }
    
    populateTable(dataToShow);
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('id-ID', { 
        day: 'numeric', 
        month: 'short',
        year: 'numeric'
    });
}

// ✅ NEW FUNCTION: Format waktu dari Google Sheets
// ✅ SIMPLIFIED: Format waktu dari Google Sheets
function formatTimeFromSheet(timeStr) {
    // Jika undefined atau null
    if (!timeStr) return '-';
    
    // Jika sudah format HH:MM atau HH:MM:SS
    if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}/.test(timeStr)) {
        return timeStr.substring(0, 5); // Ambil HH:MM saja
    }
    
    // Jika masih ada yang lolos dan berupa timestamp
    if (typeof timeStr === 'string' && timeStr.includes('T')) {
        const match = timeStr.match(/T(\d{2}):(\d{2})/);
        if (match) {
            return `${match[1]}:${match[2]}`;
        }
    }
    
    // Fallback
    return String(timeStr).substring(0, 5);
}

function updateLastUpdate() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
    });
    document.getElementById('lastUpdate').textContent = `Last update: ${timeStr}`;
}
    </script>
</body>
</html>