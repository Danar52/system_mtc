<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Availability - Maintenance Mesin System</title>
    <link rel="stylesheet" href="assets/style/style_availability.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="8" fill="white"/>
                            <path d="M16 8L8 12V20L16 24L24 20V12L16 8Z" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M16 16L8 12M16 16L24 12M16 16V24" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>MTC MACHINE</h1>
                        <p>Monitoring System</p>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="mesin_pg.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 3L3 7V13L10 17L17 13V7L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                    </svg>
                    <span>Input Breakdown</span>
                </a>
                <a href="data_breakdown.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M3 8H17M8 3V17" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Data Breakdown</span>
                </a>
                <a href="dashboard_mttr.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="8" width="4" height="9" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="8" y="3" width="4" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="13" y="10" width="4" height="7" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Dashboard MTTR</span>
                </a>
                <a href="dashboard_mtbf.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 10L7 6L11 10L17 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13 4H17V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Dashboard MTBF</span>
                </a>
                <a href="availability.html" class="nav-item active">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <span>Dashboard Availability</span>
                </a>
                <a href="index.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 17H16C16.5523 17 17 16.5523 17 16V4C17 3.44772 16.5523 3 16 3H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M8 13L3 10M3 10L8 7M3 10H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Kembali ke Menu</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <h2>Dashboard Availability</h2>
                    <p>Persentase ketersediaan mesin untuk beroperasi</p>
                </div>
                <div class="header-right">
                    <button class="btn-refresh" onclick="loadAvailabilityData()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 9C16 12.866 12.866 16 9 16C5.13401 16 2 12.866 2 9C2 5.13401 5.13401 2 9 2C11.7 2 14 3.6 15.4 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M15 2V6H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="btn-export" onclick="exportToExcel()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 11V15C15 15.5523 14.5523 16 14 16H4C3.44772 16 3 15.5523 3 15V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M9 3V12M9 12L5.5 8.5M9 12L12.5 8.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Export
                    </button>
                </div>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Info Cards -->
            <div class="info-cards">
                <div class="info-card">
                    <div class="card-icon primary">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M3 9H21M9 3V21" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="totalMesin">-</h3>
                        <p>Total Mesin</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="card-icon success">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="avgAvailability">-</h3>
                        <p>Rata-rata Availability</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="card-icon warning">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 7V13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="12" cy="16" r="1" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="totalUptime">-</h3>
                        <p>Total Uptime Hours</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="card-icon error">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="totalDowntime">-</h3>
                        <p>Total Downtime Hours</p>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <div class="filter-controls">
                    <div class="search-box">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8.5" cy="8.5" r="5.5" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M12.5 12.5L16.5 16.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <input 
                            type="text" 
                            id="searchMesin" 
                            placeholder="Cari berdasarkan ID Mesin..."
                        >
                    </div>
                    
                    <button class="btn-reset-filter" onclick="resetFilters()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M8 2L11 5M8 2L11 -1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Reset
                    </button>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-info">
                        <span class="data-count">Total: <strong id="totalData">0</strong> mesin</span>
                    </div>
                    <div class="table-legend">
                        <span class="legend-item">
                            <span class="legend-dot excellent"></span>
                            Excellent (‚â• 95%)
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot good"></span>
                            Good (85-95%)
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot fair"></span>
                            Fair (75-85%)
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot poor"></span>
                            Poor (< 75%)
                        </span>
                    </div>
                </div>
                
                <div class="table-wrapper" id="availabilityTable">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Memuat data Availability...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Detail -->
    <div id="modalDetail" class="modal">
        <div class="modal-overlay" onclick="closeModal('modalDetail')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detail Availability Mesin</h2>
                <button class="btn-close" onclick="closeModal('modalDetail')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <script>
        // ========================================
// CONFIGURATION
// ========================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxdmtsD_5BY38UqiQM_U_8anFSeUGBKU3PYrgBXCPHO1pzvgmSWC1dgHJlqcpDfUVNV3g/exec';

// State Management
let allAvailabilityData = [];
let filteredAvailabilityData = [];

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded, initializing...'); // DEBUG
    initializeApp();
});

function initializeApp() {
    console.log('üì° Calling loadAvailabilityData...'); // DEBUG
    loadAvailabilityData();
    setupEventListeners();
}

// ========================================
// EVENT LISTENERS
// ========================================
function setupEventListeners() {
    const searchInput = document.getElementById('searchMesin');
    if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
        console.log('‚úÖ Search listener attached'); // DEBUG
    }
}

// ========================================
// LOAD AVAILABILITY DATA
// ========================================
async function loadAvailabilityData() {
    console.log('üîÑ Starting to load availability data...'); // DEBUG
    showLoadingState();
    
    try {
        const url = `${SCRIPT_URL}?action=getAvailabilityDashboard&_=${Date.now()}`;
        console.log('üåê Fetching from:', url); // DEBUG
        
        const response = await fetch(url, {
            method: 'GET',
            redirect: 'follow'
        });
        
        console.log('üì• Response received:', response.status); // DEBUG
        
        const result = await response.json();
        console.log('üì¶ Parsed result:', result); // DEBUG
        
        if (result.status === 'success') {
            console.log('‚úÖ Data loaded successfully, count:', result.data.length); // DEBUG
            allAvailabilityData = result.data;
            filteredAvailabilityData = result.data;
            displayAvailabilityTable(result.data);
            updateInfoCards(result.data);
            updateDataCount(result.data.length);
        } else {
            console.error('‚ùå API returned error:', result.message); // DEBUG
            showError('Gagal memuat data Availability: ' + result.message);
        }
    } catch (error) {
        console.error('‚ùå Error loading availability data:', error); // DEBUG
        showError('Gagal memuat data Availability. Periksa koneksi Anda.');
    }
}

function showLoadingState() {
    const table = document.getElementById('availabilityTable');
    if (table) {
        table.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Memuat data Availability...</p>
            </div>
        `;
    }
}

function showError(message) {
    const table = document.getElementById('availabilityTable');
    if (table) {
        table.innerHTML = `
            <div class="loading-state">
                <p style="color: var(--color-error);">${message}</p>
            </div>
        `;
    }
}

// ========================================
// UPDATE INFO CARDS
// ========================================
function updateInfoCards(data) {
    console.log('üìä Updating info cards with data:', data); // DEBUG
    
    if (!data || data.length === 0) {
        document.getElementById('totalMesin').textContent = '0';
        document.getElementById('avgAvailability').textContent = '-';
        document.getElementById('totalUptime').textContent = '-';
        document.getElementById('totalDowntime').textContent = '-';
        return;
    }
    
    // Total Mesin
    document.getElementById('totalMesin').textContent = data.length;
    
    // Average Availability
    const avgAvailability = data.reduce((sum, item) => sum + (item.availability_percentage || 0), 0) / data.length;
    document.getElementById('avgAvailability').textContent = avgAvailability.toFixed(2) + '%';
    
    // Total Uptime
    const totalUptime = data.reduce((sum, item) => sum + (item.uptime_hours || 0), 0);
    document.getElementById('totalUptime').textContent = formatNumber(totalUptime) + ' jam';
    
    // Total Downtime
    const totalDowntime = data.reduce((sum, item) => sum + (item.total_downtime_hours || 0), 0);
    document.getElementById('totalDowntime').textContent = formatNumber(totalDowntime) + ' jam';
    
    console.log('‚úÖ Info cards updated'); // DEBUG
}

// ========================================
// DISPLAY TABLE
// ========================================
function displayAvailabilityTable(data) {
    console.log('üìã Displaying table with data:', data); // DEBUG
    
    const container = document.getElementById('availabilityTable');
    
    if (!data || data.length === 0) {
        console.warn('‚ö†Ô∏è No data to display'); // DEBUG
        container.innerHTML = `
            <div class="loading-state">
                <p>Tidak ada data Availability yang ditemukan</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>ID Mesin</th>
                    <th>Total Operating Hours</th>
                    <th>Uptime Hours</th>
                    <th>Downtime Hours</th>
                    <th>Availability (%)</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    data.forEach((row, index) => {
        console.log(`Processing row ${index}:`, row); // DEBUG
        
        const availabilityPct = row.availability_percentage || 0;
        const availabilityClass = getAvailabilityClass(availabilityPct);
        const availabilityStatus = getAvailabilityStatus(availabilityPct);
        
        html += `
            <tr>
                <td><strong>${index + 1}</strong></td>
                <td><strong>${row.id_mesin || '-'}</strong></td>
                <td>${formatNumber(row.total_operating_hours || 0)} jam</td>
                <td>${formatNumber(row.uptime_hours || 0)} jam</td>
                <td>${formatNumber(row.total_downtime_hours || 0)} jam</td>
                <td><span class="availability-indicator ${availabilityClass}">${formatNumber(availabilityPct)}%</span></td>
                <td><span class="availability-indicator ${availabilityClass}">${availabilityStatus}</span></td>
                <td>
                    <button class="btn-detail" onclick='viewDetail(${index})'>
                        Detail
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
    console.log('‚úÖ Table rendered successfully'); // DEBUG
}

function getAvailabilityClass(percentage) {
    if (percentage >= 95) return 'availability-excellent';
    if (percentage >= 85) return 'availability-good';
    if (percentage >= 75) return 'availability-fair';
    return 'availability-poor';
}

function getAvailabilityStatus(percentage) {
    if (percentage >= 95) return 'Excellent';
    if (percentage >= 85) return 'Good';
    if (percentage >= 75) return 'Fair';
    return 'Poor';
}

// ========================================
// FILTER & SEARCH
// ========================================
function applyFilters() {
    const searchTerm = document.getElementById('searchMesin').value.toLowerCase();
    
    filteredAvailabilityData = allAvailabilityData.filter(row => {
        const matchesSearch = !searchTerm || 
            (row.id_mesin && row.id_mesin.toLowerCase().includes(searchTerm));
        
        return matchesSearch;
    });
    
    displayAvailabilityTable(filteredAvailabilityData);
    updateInfoCards(filteredAvailabilityData);
    updateDataCount(filteredAvailabilityData.length);
}

function resetFilters() {
    document.getElementById('searchMesin').value = '';
    filteredAvailabilityData = allAvailabilityData;
    displayAvailabilityTable(allAvailabilityData);
    updateInfoCards(allAvailabilityData);
    updateDataCount(allAvailabilityData.length);
}

function updateDataCount(count) {
    const countEl = document.getElementById('totalData');
    if (countEl) {
        countEl.textContent = count;
    }
}

// ========================================
// VIEW DETAIL
// ========================================
function viewDetail(index) {
    const data = filteredAvailabilityData[index];
    if (!data) return;
    
    const availabilityClass = getAvailabilityClass(data.availability_percentage);
    const availabilityStatus = getAvailabilityStatus(data.availability_percentage);
    
    let html = `
        <div style="display: grid; gap: 1.5rem;">
            <div class="detail-group">
                <div class="detail-label">ID Mesin</div>
                <div class="detail-value" style="font-weight: 700; font-size: 1.5rem;">
                    ${data.id_mesin || '-'}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="detail-group">
                    <div class="detail-label">Total Operating Hours</div>
                    <div class="detail-value" style="font-weight: 700; font-size: 1.25rem; color: var(--color-info);">
                        ${formatNumber(data.total_operating_hours)} jam
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Uptime Hours</div>
                    <div class="detail-value" style="font-weight: 700; font-size: 1.25rem; color: var(--color-success);">
                        ${formatNumber(data.uptime_hours)} jam
                    </div>
                </div>
            </div>
            
            <div class="detail-group">
                <div class="detail-label">Downtime Hours</div>
                <div class="detail-value" style="font-weight: 700; font-size: 1.25rem; color: var(--color-error);">
                    ${formatNumber(data.total_downtime_hours)} jam
                </div>
            </div>
            
            <div style="padding: 1.5rem; background: linear-gradient(135deg, var(--color-gray-50), var(--color-gray-100)); border-radius: 1rem; border: 2px solid var(--color-gray-200);">
                <div style="text-align: center;">
                    <div style="font-size: 0.875rem; font-weight: 700; color: var(--color-gray-600); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem;">
                        Machine Availability
                    </div>
                    <div style="display: flex; align-items: baseline; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
                        <span style="font-size: 3rem; font-weight: 700; font-family: var(--font-mono); color: var(--color-gray-900);">
                            ${formatNumber(data.availability_percentage)}
                        </span>
                        <span style="font-size: 1.5rem; color: var(--color-gray-600);">%</span>
                    </div>
                    <span class="availability-indicator ${availabilityClass}" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                        ${availabilityStatus}
                    </span>
                </div>
            </div>
            
            <div class="detail-group">
                <div class="detail-label">Keterangan</div>
                <div class="detail-value">
                    <p style="margin-bottom: 0.5rem;">
                        <strong>Availability</strong> adalah persentase waktu mesin dalam kondisi siap untuk beroperasi (tidak breakdown).
                    </p>
                    <p style="margin-bottom: 0.5rem;"><strong>Formula:</strong> Availability = (Uptime Hours / Total Operating Hours) √ó 100%</p>
                    <p style="margin-bottom: 0.5rem;">Kategori Availability:</p>
                    <ul style="margin-left: 1.5rem; color: var(--color-gray-700);">
                        <li><strong style="color: var(--color-success);">Excellent:</strong> ‚â• 95% - Mesin sangat reliable</li>
                        <li><strong style="color: var(--color-info);">Good:</strong> 85% - 95% - Mesin dalam kondisi baik</li>
                        <li><strong style="color: var(--color-warning);">Fair:</strong> 75% - 85% - Perlu perhatian</li>
                        <li><strong style="color: var(--color-error);">Poor:</strong> < 75% - Memerlukan tindakan segera</li>
                    </ul>
                </div>
            </div>
            
            <div class="detail-group">
                <div class="detail-label">Rekomendasi</div>
                <div class="detail-value">
                    ${getRecommendation(data.availability_percentage)}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('detailContent').innerHTML = html;
    openModal('modalDetail');
}

function getRecommendation(availability) {
    if (availability >= 95) {
        return `
            <p style="color: var(--color-success-dark); font-weight: 600;">‚úÖ Availability sangat baik!</p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: var(--color-gray-700);">
                <li>Pertahankan jadwal preventive maintenance</li>
                <li>Dokumentasikan best practices yang sudah diterapkan</li>
                <li>Monitor trend untuk deteksi dini potensi masalah</li>
                <li>Share knowledge dengan tim untuk mesin lain</li>
            </ul>
        `;
    } else if (availability >= 85) {
        return `
            <p style="color: var(--color-info-dark); font-weight: 600;">‚úì Availability dalam kondisi baik.</p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: var(--color-gray-700);">
                <li>Review pola breakdown untuk identifikasi area improvement</li>
                <li>Optimalkan jadwal maintenance untuk minimize downtime</li>
                <li>Tingkatkan stock spare part critical</li>
                <li>Lakukan root cause analysis untuk recurring issues</li>
            </ul>
        `;
    } else if (availability >= 75) {
        return `
            <p style="color: var(--color-warning-dark); font-weight: 600;">‚ö†Ô∏è Availability perlu ditingkatkan.</p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: var(--color-gray-700);">
                <li>Analisa mendalam penyebab downtime terbesar</li>
                <li>Evaluasi efektivitas maintenance strategy</li>
                <li>Review competency tim maintenance</li>
                <li>Pertimbangkan predictive maintenance</li>
                <li>Audit spare part management system</li>
            </ul>
        `;
    } else {
        return `
            <p style="color: var(--color-error-dark); font-weight: 600;">üö® Availability kritis - Tindakan segera diperlukan!</p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: var(--color-gray-700);">
                <li>Lakukan comprehensive audit terhadap mesin</li>
                <li>Pertimbangkan major overhaul atau replacement</li>
                <li>Review total cost of ownership vs replacement cost</li>
                <li>Implementasi temporary backup solution</li>
                <li>Escalate ke management untuk decision making</li>
                <li>Setup dedicated task force untuk recovery plan</li>
            </ul>
        `;
    }
}

// ========================================
// EXPORT TO EXCEL
// ========================================
function exportToExcel() {
    if (!filteredAvailabilityData || filteredAvailabilityData.length === 0) {
        showAlert('‚ö†Ô∏è Tidak ada data untuk diekspor', 'error');
        return;
    }
    
    let csv = 'No,ID Mesin,Total Operating Hours,Uptime Hours,Downtime Hours,Availability (%),Status\n';
    
    filteredAvailabilityData.forEach((row, index) => {
        const availabilityStatus = getAvailabilityStatus(row.availability_percentage);
        csv += `${index + 1},"${row.id_mesin || ''}","${formatNumber(row.total_operating_hours)}","${formatNumber(row.uptime_hours)}","${formatNumber(row.total_downtime_hours)}","${formatNumber(row.availability_percentage)}","${availabilityStatus}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `availability_dashboard_${formatDateForFilename(new Date())}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('‚úÖ Data Availability berhasil diekspor!', 'success');
}

// ========================================
// MODAL FUNCTIONS
// ========================================
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// ========================================
// UTILITY FUNCTIONS
// ========================================
function formatNumber(num) {
    if (num === null || num === undefined) return '-';
    return parseFloat(num).toFixed(2);
}

function formatDateForFilename(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}${m}${d}`;
}

function showAlert(message, type) {
    const container = document.getElementById('alertContainer');
    if (!container) return;
    
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass}`;
    alertDiv.innerHTML = message;
    
    container.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.animation = 'slideUp 200ms cubic-bezier(0.4, 0, 0.2, 1)';
        setTimeout(() => alertDiv.remove(), 200);
    }, 5000);
}

// Add animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }
`;
document.head.appendChild(style);

console.log('‚úÖ Script loaded successfully'); // DEBUG
    </script>
</body>
</html>