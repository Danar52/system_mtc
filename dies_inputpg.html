<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data Breakdown - Maintenance Dies System</title>
    <link rel="stylesheet" href="assets/style/style_input_data.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .autocomplete-list.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover {
            background: #f9fafb;
        }
        
        .autocomplete-item.selected {
            background: #eff6ff;
            color: #1e40af;
        }
        
        .autocomplete-item-id {
            font-weight: 600;
            color: #111827;
            font-size: 0.875rem;
        }
        
        .autocomplete-item-name {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .autocomplete-no-results {
            padding: 12px 16px;
            color: #6b7280;
            font-size: 0.875rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="8" fill="white"/>
                            <path d="M16 8L8 12V20L16 24L24 20V12L16 8Z" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M16 16L8 12M16 16L24 12M16 16V24" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>MTC DIES</h1>
                        <p>Monitoring System</p>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dies_inputpg.html" class="nav-item active">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 3L3 7V13L10 17L17 13V7L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                    </svg>
                    <span>Input Breakdown</span>
                </a>
                <a href="dies_breakdown.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M3 8H17M8 3V17" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Data Breakdown</span>
                </a>
                <a href="dies_mttr.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="8" width="4" height="9" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="8" y="3" width="4" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="13" y="10" width="4" height="7" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Dashboard MTTR</span>
                </a>
                <a href="dies_mtbf.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 10L7 6L11 10L17 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13 4H17V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Dashboard MTBF</span>
                </a>
                <a href="dies_availability.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <span>Dashboard Availability</span>
                </a>
                <a href="index.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 17H16C16.5523 17 17 16.5523 17 16V4C17 3.44772 16.5523 3 16 3H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M8 13L3 10M3 10L8 7M3 10H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Kembali ke Menu</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <h2>Input Data Breakdown Dies</h2>
                    <p>Form pengisian data breakdown dies untuk monitoring maintenance</p>
                </div>
                <div class="header-right">
                    <div class="info-badge">
                        <span class="badge-label">No. LKD Terakhir:</span>
                        <span class="badge-value" id="lastNoLkd">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Form Container -->
            <div class="form-container">
                <form id="formBreakdown">
                    <!-- Section: Informasi LKD -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Informasi LKD</h3>
                            <p>Nomor Laporan Kerusakan Dies</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field full-width">
                                <label for="no_lkd_number" class="field-label required">
                                    Nomor LKD
                                </label>
                                <div class="lkm-input-group">
                                    <input 
                                        type="text" 
                                        id="no_lkd_number" 
                                        class="field-input lkm-number" 
                                        placeholder="001" 
                                        required 
                                        maxlength="3"
                                    >
                                    <div class="lkm-preview" id="noLkdPreview">/LKD/MTC/KMI/XII/25</div>
                                </div>
                                <div class="field-hint">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M7 10V7M7 4H7.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                    <span>Nomor disarankan: <strong id="suggestedNoLkd">Loading...</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Data Dies -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Data Dies</h3>
                            <p>Identitas dies yang mengalami breakdown</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="id_dies" class="field-label required">
                                    ID Dies
                                </label>
                                <div class="autocomplete-container">
                                    <input 
                                        type="text" 
                                        id="id_dies" 
                                        class="field-input" 
                                        placeholder="Ketik ID Dies (contoh: D-001)"
                                        autocomplete="off"
                                        required
                                    >
                                    <div id="autocompleteList" class="autocomplete-list"></div>
                                </div>
                                <div class="field-hint">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M7 10V7M7 4H7.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                    <span>Ketik ID Dies untuk mencari data</span>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="nama_dies" class="field-label required">
                                    Nama Dies
                                </label>
                                <input 
                                    type="text" 
                                    id="nama_dies" 
                                    class="field-input" 
                                    placeholder="Otomatis terisi" 
                                    readonly
                                >
                            </div>
                            <div class="form-field">
                                <label for="id_proses" class="field-label required">
                                    ID Proses
                                </label>
                                <input 
                                    type="text" 
                                    id="id_proses" 
                                    class="field-input" 
                                    placeholder="Otomatis terisi" 
                                    readonly
                                >
                            </div>
                            <div class="form-field">
                                <label for="nama_proses" class="field-label required">
                                    Nama Proses
                                </label>
                                <input 
                                    type="text" 
                                    id="nama_proses" 
                                    class="field-input" 
                                    placeholder="Otomatis terisi" 
                                    readonly
                                >
                            </div>
                            <div class="form-field full-width">
                                <label for="id_cust" class="field-label required">
                                    Customer
                                </label>
                                <input 
                                    type="text" 
                                    id="id_cust" 
                                    class="field-input" 
                                    placeholder="Otomatis terisi" 
                                    readonly
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Section: Waktu Breakdown -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Waktu Breakdown</h3>
                            <p>Tanggal dan jam terjadinya breakdown</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="tanggal_breakdown" class="field-label required">
                                    Tanggal Breakdown
                                </label>
                                <input 
                                    type="date" 
                                    id="tanggal_breakdown" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                            <div class="form-field">
                                <label for="jam_breakdown" class="field-label required">
                                    Jam Breakdown
                                </label>
                                <input 
                                    type="time" 
                                    id="jam_breakdown" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Section: Waktu Perbaikan -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Waktu Perbaikan</h3>
                            <p>Jadwal mulai dan selesai proses perbaikan</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="tanggal_mulai_perbaikan" class="field-label required">
                                    Tanggal Mulai Perbaikan
                                </label>
                                <input 
                                    type="date" 
                                    id="tanggal_mulai_perbaikan" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                            <div class="form-field">
                                <label for="jam_mulai_perbaikan" class="field-label required">
                                    Jam Mulai Perbaikan
                                </label>
                                <input 
                                    type="time" 
                                    id="jam_mulai_perbaikan" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                            <div class="form-field">
                                <label for="tanggal_selesai_perbaikan" class="field-label required">
                                    Tanggal Selesai Perbaikan
                                </label>
                                <input 
                                    type="date" 
                                    id="tanggal_selesai_perbaikan" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                            <div class="form-field">
                                <label for="jam_selesai_perbaikan" class="field-label required">
                                    Jam Selesai Perbaikan
                                </label>
                                <input 
                                    type="time" 
                                    id="jam_selesai_perbaikan" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Section: Detail Breakdown -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Detail Breakdown</h3>
                            <p>Informasi lengkap mengenai kerusakan dan perbaikan</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field full-width">
                                <label for="problem_dies" class="field-label required">
                                    Problem Dies
                                </label>
                                <textarea 
                                    id="problem_dies" 
                                    class="field-textarea" 
                                    rows="3"
                                    placeholder="Deskripsikan masalah yang terjadi pada dies..."
                                    required
                                ></textarea>
                            </div>
                            <div class="form-field full-width">
                                <label for="penyebab_breakdown" class="field-label required">
                                    Penyebab Breakdown
                                </label>
                                <textarea 
                                    id="penyebab_breakdown" 
                                    class="field-textarea" 
                                    rows="3"
                                    placeholder="Jelaskan penyebab terjadinya breakdown..."
                                    required
                                ></textarea>
                            </div>
                            <div class="form-field full-width">
                                <label for="tindakan_perbaikan" class="field-label required">
                                    Tindakan Perbaikan
                                </label>
                                <textarea 
                                    id="tindakan_perbaikan" 
                                    class="field-textarea" 
                                    rows="3"
                                    placeholder="Deskripsikan tindakan perbaikan yang dilakukan..."
                                    required
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section: PIC -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Person In Charge</h3>
                            <p>Penanggung jawab maintenance</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field full-width">
                                <label for="pic_maintenance" class="field-label required">
                                    PIC Maintenance
                                </label>
                                <select 
                                    id="pic_maintenance" 
                                    class="field-input" 
                                    required
                                >
                                    <option value="">Pilih PIC Maintenance...</option>
                                    <option value="Retno">Retno</option>
                                    <option value="Agus">Agus</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="resetForm()">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 9C2 5.13401 5.13401 2 9 2C12.866 2 16 5.13401 16 9C16 12.866 12.866 16 9 16C5.13401 16 2 12.866 2 9Z" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M9 5V9L11.5 11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            Reset Form
                        </button>
                        <button type="submit" class="btn-primary" id="btnSubmit">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 9L9 15L3 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 3V15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            Simpan Data
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        // ========================================
        // CONFIGURATION - GANTI URL INI DENGAN URL DEPLOYMENT APPS SCRIPT KAMU
        // ========================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyEbWdMn0nNnZeL35btUunBKcYJT3Hl39q8dHjlpgy63pie0FBgbLYLX83W8jKSK0Sz/exec';

        // State Management
        let masterDiesData = [];
        let selectedIndex = -1;

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadMasterDies();
            loadLastNoLKD();
            setupEventListeners();
            setDefaultDates();
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        function setupEventListeners() {
            const idDiesInput = document.getElementById('id_dies');
            const autocompleteList = document.getElementById('autocompleteList');
            
            // ID Dies input events
            idDiesInput.addEventListener('input', handleDiesInput);
            idDiesInput.addEventListener('focus', handleDiesInput);
            idDiesInput.addEventListener('keydown', handleKeyNavigation);
            
            // Close autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    autocompleteList.classList.remove('active');
                }
            });
            
            // LKD number input
            document.getElementById('no_lkd_number').addEventListener('input', updateNoLkdPreview);
            
            // Breakdown date change
            document.getElementById('tanggal_breakdown').addEventListener('change', updateNoLkdPreview);
            
            // Form submission
            document.getElementById('formBreakdown').addEventListener('submit', handleFormSubmit);
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal_breakdown').value = today;
            document.getElementById('tanggal_mulai_perbaikan').value = today;
            document.getElementById('tanggal_selesai_perbaikan').value = today;
        }

        // ========================================
        // MASTER DIES FUNCTIONS
        // ========================================
        async function loadMasterDies() {
            try {
                const url = `${SCRIPT_URL}?action=getMasterDies&_=${Date.now()}`;
                const response = await fetch(url, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    masterDiesData = result.data;
                } else {
                    showAlert('Gagal memuat data dies: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error loading master dies:', error);
                showAlert('Gagal memuat data dies. Periksa koneksi dan URL deployment.', 'error');
            }
        }

        // ========================================
        // AUTOCOMPLETE FUNCTIONS
        // ========================================
        function handleDiesInput(e) {
            const input = e.target.value.toUpperCase();
            const autocompleteList = document.getElementById('autocompleteList');
            
            // Clear previous data if input is empty
            if (!input.trim()) {
                clearDiesFields();
                autocompleteList.classList.remove('active');
                return;
            }
            
            // Filter dies data
            const matches = masterDiesData.filter(dies => 
                dies.id_dies.toUpperCase().includes(input) ||
                dies.nama_dies.toUpperCase().includes(input)
            );
            
            // Show autocomplete
            if (matches.length > 0) {
                showAutocomplete(matches);
            } else {
                showNoResults();
            }
            
            // Auto-fill if exact match
            const exactMatch = masterDiesData.find(dies => 
                dies.id_dies.toUpperCase() === input
            );
            
            if (exactMatch) {
                fillDiesData(exactMatch);
                autocompleteList.classList.remove('active');
            }
        }

        function showAutocomplete(matches) {
            const autocompleteList = document.getElementById('autocompleteList');
            autocompleteList.innerHTML = '';
            selectedIndex = -1;
            
            matches.forEach((dies, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div class="autocomplete-item-id">${dies.id_dies}</div>
                    <div class="autocomplete-item-name">${dies.nama_dies} - ${dies.nama_proses}</div>
                `;
                
                item.addEventListener('click', function() {
                    document.getElementById('id_dies').value = dies.id_dies;
                    fillDiesData(dies);
                    autocompleteList.classList.remove('active');
                });
                
                autocompleteList.appendChild(item);
            });
            
            autocompleteList.classList.add('active');
        }

        function showNoResults() {
            const autocompleteList = document.getElementById('autocompleteList');
            autocompleteList.innerHTML = '<div class="autocomplete-no-results">Tidak ada data dies yang cocok</div>';
            autocompleteList.classList.add('active');
            clearDiesFields();
        }

        function handleKeyNavigation(e) {
            const autocompleteList = document.getElementById('autocompleteList');
            const items = autocompleteList.querySelectorAll('.autocomplete-item');
            
            if (!items.length) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex].click();
            } else if (e.key === 'Escape') {
                autocompleteList.classList.remove('active');
            }
        }

        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function fillDiesData(dies) {
            document.getElementById('nama_dies').value = dies.nama_dies;
            document.getElementById('id_proses').value = dies.id_proses;
            document.getElementById('nama_proses').value = dies.nama_proses;
            document.getElementById('id_cust').value = dies.id_cust;
        }

        function clearDiesFields() {
            document.getElementById('nama_dies').value = '';
            document.getElementById('id_proses').value = '';
            document.getElementById('nama_proses').value = '';
            document.getElementById('id_cust').value = '';
        }

        // ========================================
        // LKD NUMBER FUNCTIONS
        // ========================================
        async function loadLastNoLKD() {
            try {
                const url = `${SCRIPT_URL}?action=getLastNoLKD&_=${Date.now()}`;
                const response = await fetch(url, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('lastNoLkd').textContent = result.lastNumber || '-';
                    document.getElementById('suggestedNoLkd').textContent = result.suggestedNumber || '001';
                    document.getElementById('no_lkd_number').placeholder = result.suggestedNumber || '001';
                }
            } catch (error) {
                console.error('Error loading last no LKD:', error);
                document.getElementById('lastNoLkd').textContent = 'Error';
                document.getElementById('suggestedNoLkd').textContent = 'Error';
            }
        }

        function updateNoLkdPreview() {
            const number = document.getElementById('no_lkd_number').value.padStart(3, '0') || '000';
            const breakdownDate = document.getElementById('tanggal_breakdown').value;
            
            if (breakdownDate) {
                const date = new Date(breakdownDate);
                const month = toRoman(date.getMonth() + 1);
                const year = date.getFullYear().toString().slice(-2);
                
                document.getElementById('noLkdPreview').textContent = 
                    `/${number}/LKD/MTC/KMI/${month}/${year}`;
            } else {
                document.getElementById('noLkdPreview').textContent = 
                    `/${number}/LKD/MTC/KMI/XII/25`;
            }
        }

        function toRoman(num) {
            const romanNumerals = [
                { value: 12, numeral: 'XII' },
                { value: 11, numeral: 'XI' },
                { value: 10, numeral: 'X' },
                { value: 9, numeral: 'IX' },
                { value: 8, numeral: 'VIII' },
                { value: 7, numeral: 'VII' },
                { value: 6, numeral: 'VI' },
                { value: 5, numeral: 'V' },
                { value: 4, numeral: 'IV' },
                { value: 3, numeral: 'III' },
                { value: 2, numeral: 'II' },
                { value: 1, numeral: 'I' }
            ];
            
            for (let i = 0; i < romanNumerals.length; i++) {
                if (num === romanNumerals[i].value) {
                    return romanNumerals[i].numeral;
                }
            }
            return 'I';
        }

        // ========================================
        // FORM SUBMISSION
        // ========================================
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Validate ID Dies
            const idDiesValue = document.getElementById('id_dies').value.toUpperCase();
            const diesExists = masterDiesData.find(dies => 
                dies.id_dies.toUpperCase() === idDiesValue
            );
            
            if (!diesExists) {
                showAlert('❌ ID Dies tidak ditemukan di master data!', 'error');
                document.getElementById('id_dies').focus();
                return;
            }
            
            const btn = document.getElementById('btnSubmit');
            const originalText = btn.innerHTML;
            
            // Disable button and show loading state
            btn.disabled = true;
            btn.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
                    <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
                </svg>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
                Menyimpan...
            `;
            
            // Prepare form data
            const formData = new URLSearchParams();
            formData.append('action', 'addBreakdown');
            formData.append('no_lkd_number', document.getElementById('no_lkd_number').value);
            formData.append('id_dies', document.getElementById('id_dies').value.toUpperCase());
            formData.append('nama_dies', document.getElementById('nama_dies').value);
            formData.append('id_proses', document.getElementById('id_proses').value);
            formData.append('nama_proses', document.getElementById('nama_proses').value);
            formData.append('id_cust', document.getElementById('id_cust').value);
            formData.append('tanggal_breakdown', document.getElementById('tanggal_breakdown').value);
            formData.append('jam_breakdown', document.getElementById('jam_breakdown').value);
            formData.append('tanggal_mulai_perbaikan', document.getElementById('tanggal_mulai_perbaikan').value);
            formData.append('jam_mulai_perbaikan', document.getElementById('jam_mulai_perbaikan').value);
            formData.append('tanggal_selesai_perbaikan', document.getElementById('tanggal_selesai_perbaikan').value);
            formData.append('jam_selesai_perbaikan', document.getElementById('jam_selesai_perbaikan').value);
            formData.append('problem_dies', document.getElementById('problem_dies').value);
            formData.append('penyebab_breakdown', document.getElementById('penyebab_breakdown').value);
            formData.append('tindakan_perbaikan', document.getElementById('tindakan_perbaikan').value);
            formData.append('pic_maintenance', document.getElementById('pic_maintenance').value);
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const successMessage = `
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="font-weight: 600; font-size: 1rem;">✅ Data berhasil disimpan!</div>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.875rem;">
                                <span style="font-weight: 500;">No LKD:</span>
                                <span style="font-family: 'Courier New', monospace;">${result.data.no_lkd}</span>
                                <span style="font-weight: 500;">Status:</span>
                                <span>${result.data.status_breakdown}</span>
                                <span style="font-weight: 500;">Repair Time:</span>
                                <span>${result.data.repair_time.toFixed(2)} jam</span>
                                <span style="font-weight: 500;">Total Downtime:</span>
                                <span>${result.data.total_downtime.toFixed(2)} jam</span>
                            </div>
                        </div>
                    `;
                    showAlert(successMessage, 'success');
                    
                    // Reset form
                    document.getElementById('formBreakdown').reset();
                    setDefaultDates();
                    loadLastNoLKD();
                    updateNoLkdPreview();
                    
                    // Scroll to top to show success message
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showAlert('❌ ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showAlert('❌ Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = message;
            
            container.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.style.animation = 'slideUp 200ms cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => alertDiv.remove(), 200);
            }, 5000);
        }

        function resetForm() {
            if (confirm('Apakah Anda yakin ingin mereset form? Semua data yang belum disimpan akan hilang.')) {
                document.getElementById('formBreakdown').reset();
                setDefaultDates();
                updateNoLkdPreview();
                document.getElementById('alertContainer').innerHTML = '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Add slide up animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-10px);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>