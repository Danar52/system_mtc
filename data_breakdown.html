<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Breakdown - Maintenance Mesin System</title>
    <link rel="stylesheet" href="assets/style/style_data_breakdown.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
</head>

<body>
    <div class="page-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="8" fill="white"/>
                            <path d="M16 8L8 12V20L16 24L24 20V12L16 8Z" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M16 16L8 12M16 16L24 12M16 16V24" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>MTC MACHINE</h1>
                        <p>Monitoring System</p>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="mesin_pg.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 3L3 7V13L10 17L17 13V7L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                    </svg>
                    <span>Input Breakdown</span>
                </a>
                <a href="data_breakdown.html" class="nav-item active">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M3 8H17M8 3V17" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Data Breakdown</span>
                </a>
                <a href="dashboard_mttr.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="8" width="4" height="9" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="8" y="3" width="4" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="13" y="10" width="4" height="7" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Dashboard MTTR</span>
                </a>
                <a href="dashboard_mtbf.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 10L7 6L11 10L17 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13 4H17V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Dashboard MTBF</span>
                </a>
                <a href="availability.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <span>Dashboard Availability</span>
                </a>
                <a href="index.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 17H16C16.5523 17 17 16.5523 17 16V4C17 3.44772 16.5523 3 16 3H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M8 13L3 10M3 10L8 7M3 10H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Kembali ke Menu</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <h2>Data Breakdown</h2>
                    <p>
                        Daftar lengkap riwayat breakdown mesin dengan fungsi pencarian dan
                        filter
                    </p>
                </div>
                <div class="header-right">
                    <button class="btn-export" onclick="exportToExcel()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 11V15C15 15.5523 14.5523 16 14 16H4C3.44772 16 3 15.5523 3 15V11"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                            <path d="M9 3V12M9 12L5.5 8.5M9 12L12.5 8.5" stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Export Excel
                    </button>
                </div>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Search & Filter Section -->
            <div class="filter-section">
                <div class="search-box">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8.5" cy="8.5" r="5.5" stroke="currentColor" stroke-width="1.5" />
                        <path d="M12.5 12.5L16.5 16.5" stroke="currentColor" stroke-width="1.5"
                            stroke-linecap="round" />
                    </svg>
                    <input type="text" id="searchBreakdown"
                        placeholder="Cari berdasarkan No LKM, Nama Mesin, atau PIC Maintenance..." />
                </div>

                <div class="filter-controls">
                    <select id="filterStatus" class="filter-select">
                        <option value="">Semua Status</option>
                        <option value="Ringan">Ringan</option>
                        <option value="Sedang">Sedang</option>
                        <option value="Berat">Berat</option>
                    </select>

                    <select id="filterBulan" class="filter-select">
                        <option value="">Semua Bulan</option>
                    </select>

                    <select id="filterMesin" class="filter-select">
                        <option value="">Semua Mesin</option>
                    </select>

                    <button class="btn-reset-filter" onclick="resetFilters()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                            <path d="M8 2L11 5M8 2L11 -1" stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Reset
                    </button>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-info">
                        <span class="data-count">Total: <strong id="totalData">0</strong> data</span>
                    </div>
                </div>

                <div class="table-wrapper" id="breakdownTable">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Memuat data...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal View Detail -->
    <div id="modalView" class="modal">
        <div class="modal-overlay" onclick="closeModal('modalView')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detail Breakdown</h2>
                <button class="btn-close" onclick="closeModal('modalView')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <!-- Modal Edit -->
    <div id="modalEdit" class="modal">
        <div class="modal-overlay" onclick="closeModal('modalEdit')"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Edit Data Breakdown</h2>
                <button class="btn-close" onclick="closeModal('modalEdit')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="formEdit">
                    <input type="hidden" id="edit_no_lkm" />

                    <div class="form-section">
                        <h3 class="section-title">Data Mesin</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit_id_mesin" class="field-label required">ID Mesin</label>
                                <select id="edit_id_mesin" class="field-input" required>
                                    <option value="">Pilih mesin...</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="edit_nama_mesin" class="field-label">Nama Mesin</label>
                                <input type="text" id="edit_nama_mesin" class="field-input" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Waktu Breakdown</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit_tanggal_breakdown" class="field-label required">Tanggal
                                    Breakdown</label>
                                <input type="date" id="edit_tanggal_breakdown" class="field-input" required />
                            </div>
                            <div class="form-field">
                                <label for="edit_jam_breakdown" class="field-label required">Jam Breakdown</label>
                                <input type="time" id="edit_jam_breakdown" class="field-input" required />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Waktu Perbaikan</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit_tanggal_mulai_perbaikan" class="field-label required">Tanggal
                                    Mulai</label>
                                <input type="date" id="edit_tanggal_mulai_perbaikan" class="field-input" required />
                            </div>
                            <div class="form-field">
                                <label for="edit_jam_mulai_perbaikan" class="field-label required">Jam Mulai</label>
                                <input type="time" id="edit_jam_mulai_perbaikan" class="field-input" required />
                            </div>
                            <div class="form-field">
                                <label for="edit_tanggal_selesai_perbaikan" class="field-label required">Tanggal
                                    Selesai</label>
                                <input type="date" id="edit_tanggal_selesai_perbaikan" class="field-input" required />
                            </div>
                            <div class="form-field">
                                <label for="edit_jam_selesai_perbaikan" class="field-label required">Jam Selesai</label>
                                <input type="time" id="edit_jam_selesai_perbaikan" class="field-input" required />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Detail Breakdown</h3>
                        <div class="form-grid-single">
                            <div class="form-field">
                                <label for="edit_problem_mesin" class="field-label required">Problem Mesin</label>
                                <textarea id="edit_problem_mesin" class="field-textarea" rows="3" required></textarea>
                            </div>
                            <div class="form-field">
                                <label for="edit_penyebab_breakdown" class="field-label required">Penyebab
                                    Breakdown</label>
                                <textarea id="edit_penyebab_breakdown" class="field-textarea" rows="3"
                                    required></textarea>
                            </div>
                            <div class="form-field">
                                <label for="edit_tindakan_perbaikan" class="field-label required">Tindakan
                                    Perbaikan</label>
                                <textarea id="edit_tindakan_perbaikan" class="field-textarea" rows="3"
                                    required></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">PIC Maintenance</h3>
                        <div class="form-grid-single">
                            <div class="form-field">
                                <label for="edit_pic_maintenance" class="field-label required">Nama PIC</label>
                                <input type="text" id="edit_pic_maintenance" class="field-input" required />
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('modalEdit')">
                            Batal
                        </button>
                        <button type="submit" class="btn-primary" id="btnUpdate">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 9L7 13L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            Update Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const SCRIPT_URL =
            "https://script.google.com/macros/s/AKfycbxdmtsD_5BY38UqiQM_U_8anFSeUGBKU3PYrgBXCPHO1pzvgmSWC1dgHJlqcpDfUVNV3g/exec";

        // State Management
        let masterMesinData = [];
        let allBreakdownData = [];
        let filteredBreakdownData = [];

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener("DOMContentLoaded", function () {
            initializeApp();
        });

        function initializeApp() {
            loadMasterMesin();
            loadBreakdownData();
            setupEventListeners();
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        function setupEventListeners() {
            // Search input
            document
                .getElementById("searchBreakdown")
                .addEventListener("input", applyFilters);

            // Filter selects
            document
                .getElementById("filterStatus")
                .addEventListener("change", applyFilters);
            document
                .getElementById("filterBulan")
                .addEventListener("change", applyFilters);
            document
                .getElementById("filterMesin")
                .addEventListener("change", applyFilters);

            // Edit form mesin change
            document
                .getElementById("edit_id_mesin")
                .addEventListener("change", handleEditMesinChange);

            // Edit form submit
            document
                .getElementById("formEdit")
                .addEventListener("submit", handleUpdate);
        }

        function handleEditMesinChange(e) {
            const selectedId = e.target.value;
            const mesin = masterMesinData.find((m) => m.id_mesin === selectedId);
            document.getElementById("edit_nama_mesin").value = mesin
                ? mesin.nama_mesin
                : "";
        }

        // ========================================
        // LOAD MASTER DATA
        // ========================================
        async function loadMasterMesin() {
            try {
                const url = `${SCRIPT_URL}?action=getMasterMesin&_=${Date.now()}`;
                const response = await fetch(url, {
                    method: "GET",
                    redirect: "follow",
                });

                const result = await response.json();

                if (result.status === "success") {
                    masterMesinData = result.data;
                    populateMesinFilter(result.data);
                } else {
                    console.error("Error:", result.message);
                }
            } catch (error) {
                console.error("Error loading master mesin:", error);
            }
        }

        function populateMesinFilter(data) {
            const filterSelect = document.getElementById("filterMesin");

            data.forEach((mesin) => {
                const option = document.createElement("option");
                option.value = mesin.id_mesin;
                option.textContent = `${mesin.id_mesin} - ${mesin.nama_mesin}`;
                filterSelect.appendChild(option);
            });
        }

        // Populate Bulan Filter
        function populateBulanFilter(data) {
            const filterBulan = document.getElementById("filterBulan");
            // Remove existing options except the first
            while (filterBulan.options.length > 1) {
                filterBulan.remove(1);
            }
            const bulanSet = new Set();

            data.forEach((row) => {
                if (row.tanggal_breakdown) {
                    const date = new Date(row.tanggal_breakdown);
                    if (!isNaN(date.getTime())) {
                        const key = `${date.getFullYear()}-${String(
                            date.getMonth() + 1
                        ).padStart(2, "0")}`;
                        bulanSet.add(key);
                    }
                }
            });

            Array.from(bulanSet)
                .sort()
                .forEach((key) => {
                    const [year, month] = key.split("-");
                    const date = new Date(year, month - 1);
                    const option = document.createElement("option");
                    option.value = key;
                    option.textContent = date.toLocaleDateString("id-ID", {
                        month: "long",
                        year: "numeric",
                    });
                    filterBulan.appendChild(option);
                });
        }

        // ========================================
        // LOAD BREAKDOWN DATA
        // ========================================
        async function loadBreakdownData() {
            showLoadingState();

            try {
                const url = `${SCRIPT_URL}?action=getBreakdownData&_=${Date.now()}`;
                const response = await fetch(url, {
                    method: "GET",
                    redirect: "follow",
                });

                const result = await response.json();

                if (result.status === "success") {
                    allBreakdownData = result.data;
                    filteredBreakdownData = result.data;
                    populateBulanFilter(result.data);
                    displayBreakdownTable(result.data);
                    updateDataCount(result.data.length);
                } else {
                    showError("Gagal memuat data breakdown");
                }
            } catch (error) {
                console.error("Error loading breakdown data:", error);
                showError("Gagal memuat data breakdown. Periksa koneksi Anda.");
            }
        }

        function showLoadingState() {
            document.getElementById("breakdownTable").innerHTML = `
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Memuat data...</p>
        </div>
    `;
        }

        function showError(message) {
            document.getElementById("breakdownTable").innerHTML = `
        <div class="loading-state">
            <p style="color: var(--color-error);">${message}</p>
        </div>
    `;
        }

        // ========================================
        // DISPLAY TABLE
        // ========================================
        function displayBreakdownTable(data) {
            const container = document.getElementById("breakdownTable");

            if (!data || data.length === 0) {
                container.innerHTML = `
            <div class="loading-state">
                <p>Tidak ada data yang ditemukan</p>
            </div>
        `;
                return;
            }

            let html = `
        <table>
            <thead>
                <tr>
                    <th>No LKM</th>
                    <th>ID Mesin</th>
                    <th>Nama Mesin</th>
                    <th>Tanggal</th>
                    <th>Problem</th>
                    <th>Status</th>
                    <th>Repair Time</th>
                    <th>Downtime</th>
                    <th>PIC</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
    `;

            data.forEach((row, index) => {
                const statusClass = getStatusClass(row.status_breakdown);
                const rowDataStr = JSON.stringify(row).replace(/"/g, "&quot;");

                html += `
            <tr>
                <td><strong>${row.no_lkm || "-"}</strong></td>
                <td>${row.id_mesin || "-"}</td>
                <td>${row.nama_mesin || "-"}</td>
                <td>${formatDate(row.tanggal_breakdown)}<br><small>${row.jam_breakdown || ""
                    }</small></td>
                <td>${truncateText(row.problem_mesin, 40)}</td>
                <td><span class="status-badge ${statusClass}">${row.status_breakdown || "-"
                    }</span></td>
                <td>${formatNumber(row.repair_time)} jam</td>
                <td>${formatNumber(row.total_downtime)} jam</td>
                <td>${row.pic_maintenance || "-"}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-view" onclick='viewDetail(${index})'>Lihat</button>
                        <button class="btn-edit" onclick='editData(${index})'>Edit</button>
                        <button class="btn-delete" onclick='deleteData("${row.no_lkm
                    }")'>Hapus</button>
                    </div>
                </td>
            </tr>
        `;
            });

            html += `
            </tbody>
        </table>
    `;

            container.innerHTML = html;
        }

        function getStatusClass(status) {
            if (!status) return "status-ringan";
            const statusLower = status.toLowerCase();
            if (statusLower === "ringan") return "status-ringan";
            if (statusLower === "sedang") return "status-sedang";
            if (statusLower === "berat") return "status-berat";
            return "status-ringan";
        }

        // ========================================
        // FILTER & SEARCH
        // ========================================
        function applyFilters() {
            const searchTerm = document
                .getElementById("searchBreakdown")
                .value.toLowerCase();
            const statusFilter = document.getElementById("filterStatus").value;
            const mesinFilter = document.getElementById("filterMesin").value;
            const bulanFilter = document.getElementById("filterBulan").value;

            filteredBreakdownData = allBreakdownData.filter((row) => {
                const matchesSearch =
                    !searchTerm ||
                    (row.no_lkm && row.no_lkm.toLowerCase().includes(searchTerm)) ||
                    (row.nama_mesin &&
                        row.nama_mesin.toLowerCase().includes(searchTerm)) ||
                    (row.pic_maintenance &&
                        row.pic_maintenance.toLowerCase().includes(searchTerm));

                const matchesStatus =
                    !statusFilter || row.status_breakdown === statusFilter;
                const matchesMesin = !mesinFilter || row.id_mesin === mesinFilter;

                let matchesBulan = true;
                if (bulanFilter && row.tanggal_breakdown) {
                    const date = new Date(row.tanggal_breakdown);
                    const key = `${date.getFullYear()}-${String(
                        date.getMonth() + 1
                    ).padStart(2, "0")}`;
                    matchesBulan = key === bulanFilter;
                }

                return matchesSearch && matchesStatus && matchesMesin && matchesBulan;
            });

            displayBreakdownTable(filteredBreakdownData);
            updateDataCount(filteredBreakdownData.length);
        }

        function resetFilters() {
            document.getElementById("searchBreakdown").value = "";
            document.getElementById("filterStatus").value = "";
            document.getElementById("filterBulan").value = "";
            document.getElementById("filterMesin").value = "";

            filteredBreakdownData = allBreakdownData;
            displayBreakdownTable(allBreakdownData);
            updateDataCount(allBreakdownData.length);
        }

        function updateDataCount(count) {
            document.getElementById("totalData").textContent = count;
        }

        // ========================================
        // VIEW DETAIL
        // ========================================
        function viewDetail(index) {
            const data = filteredBreakdownData[index];
            if (!data) return;

            const statusClass = getStatusClass(data.status_breakdown);

            let html = `
        <div style="display: grid; gap: 1.5rem;">
            <div class="detail-group">
                <div class="detail-label">No LKM</div>
                <div class="detail-value" style="font-family: var(--font-mono); font-weight: 700; font-size: 1.125rem;">
                    ${data.no_lkm || "-"}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="detail-group">
                    <div class="detail-label">ID Mesin</div>
                    <div class="detail-value">${data.id_mesin || "-"}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Nama Mesin</div>
                    <div class="detail-value">${data.nama_mesin || "-"}</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="detail-group">
                    <div class="detail-label">Tanggal Breakdown</div>
                    <div class="detail-value">
                        ${formatDate(data.tanggal_breakdown)}<br>
                        <small style="color: var(--color-gray-600);">Pukul ${data.jam_breakdown || "-"
                }</small>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Status Breakdown</div>
                    <div class="detail-value">
                        <span class="status-badge ${statusClass}">${data.status_breakdown || "-"
                }</span>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="detail-group">
                    <div class="detail-label">Mulai Perbaikan</div>
                    <div class="detail-value">
                        ${formatDate(data.tanggal_mulai_perbaikan)}<br>
                        <small style="color: var(--color-gray-600);">Pukul ${data.jam_mulai_perbaikan || "-"
                }</small>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Selesai Perbaikan</div>
                    <div class="detail-value">
                        ${formatDate(data.tanggal_selesai_perbaikan)}<br>
                        <small style="color: var(--color-gray-600);">Pukul ${data.jam_selesai_perbaikan || "-"
                }</small>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="detail-group">
                    <div class="detail-label">Repair Time</div>
                    <div class="detail-value" style="font-weight: 700; color: var(--color-info);">
                        ${formatNumber(data.repair_time)} jam
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Total Downtime</div>
                    <div class="detail-value" style="font-weight: 700; color: var(--color-error);">
                        ${formatNumber(data.total_downtime)} jam
                    </div>
                </div>
            </div>
            
            <div class="detail-group">
                <div class="detail-label">Problem Mesin</div>
                <div class="detail-value">${data.problem_mesin || "-"}</div>
            </div>
            
            <div class="detail-group">
                <div class="detail-label">Penyebab Breakdown</div>
                <div class="detail-value">${data.penyebab_breakdown || "-"
                }</div>
            </div>
            
            <div class="detail-group">
                <div class="detail-label">Tindakan Perbaikan</div>
                <div class="detail-value">${data.tindakan_perbaikan || "-"
                }</div>
            </div>
            
            <div class="detail-group">
                <div class="detail-label">PIC Maintenance</div>
                <div class="detail-value" style="font-weight: 600;">
                    ${data.pic_maintenance || "-"}
                </div>
            </div>
        </div>
    `;

            document.getElementById("detailContent").innerHTML = html;
            openModal("modalView");
        }

        // ========================================
        // EDIT DATA
        // ========================================
        function editData(index) {
            const data = filteredBreakdownData[index];
            if (!data) return;

            const select = document.getElementById("edit_id_mesin");
            select.innerHTML = '<option value="">Pilih mesin...</option>';

            masterMesinData.forEach((mesin) => {
                const option = document.createElement("option");
                option.value = mesin.id_mesin;
                option.textContent = `${mesin.id_mesin} - ${mesin.nama_mesin}`;
                if (mesin.id_mesin === data.id_mesin) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            document.getElementById("edit_no_lkm").value = data.no_lkm;
            document.getElementById("edit_id_mesin").value = data.id_mesin;
            document.getElementById("edit_nama_mesin").value = data.nama_mesin;
            document.getElementById("edit_tanggal_breakdown").value =
                data.tanggal_breakdown;
            document.getElementById("edit_jam_breakdown").value =
                data.jam_breakdown;
            document.getElementById("edit_tanggal_mulai_perbaikan").value =
                data.tanggal_mulai_perbaikan;
            document.getElementById("edit_jam_mulai_perbaikan").value =
                data.jam_mulai_perbaikan;
            document.getElementById("edit_tanggal_selesai_perbaikan").value =
                data.tanggal_selesai_perbaikan;
            document.getElementById("edit_jam_selesai_perbaikan").value =
                data.jam_selesai_perbaikan;
            document.getElementById("edit_problem_mesin").value =
                data.problem_mesin;
            document.getElementById("edit_penyebab_breakdown").value =
                data.penyebab_breakdown;
            document.getElementById("edit_tindakan_perbaikan").value =
                data.tindakan_perbaikan;
            document.getElementById("edit_pic_maintenance").value =
                data.pic_maintenance;

            openModal("modalEdit");
        }

        async function handleUpdate(e) {
            e.preventDefault();

            const btn = document.getElementById("btnUpdate");
            const originalHTML = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
            <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
        </svg>
        Mengupdate...
    `;

            const formData = new URLSearchParams();
            formData.append("action", "updateBreakdown");
            formData.append("no_lkm", document.getElementById("edit_no_lkm").value);
            formData.append(
                "id_mesin",
                document.getElementById("edit_id_mesin").value
            );
            formData.append(
                "nama_mesin",
                document.getElementById("edit_nama_mesin").value
            );
            formData.append(
                "tanggal_breakdown",
                document.getElementById("edit_tanggal_breakdown").value
            );
            formData.append(
                "jam_breakdown",
                document.getElementById("edit_jam_breakdown").value
            );
            formData.append(
                "tanggal_mulai_perbaikan",
                document.getElementById("edit_tanggal_mulai_perbaikan").value
            );
            formData.append(
                "jam_mulai_perbaikan",
                document.getElementById("edit_jam_mulai_perbaikan").value
            );
            formData.append(
                "tanggal_selesai_perbaikan",
                document.getElementById("edit_tanggal_selesai_perbaikan").value
            );
            formData.append(
                "jam_selesai_perbaikan",
                document.getElementById("edit_jam_selesai_perbaikan").value
            );
            formData.append(
                "problem_mesin",
                document.getElementById("edit_problem_mesin").value
            );
            formData.append(
                "penyebab_breakdown",
                document.getElementById("edit_penyebab_breakdown").value
            );
            formData.append(
                "tindakan_perbaikan",
                document.getElementById("edit_tindakan_perbaikan").value
            );
            formData.append(
                "pic_maintenance",
                document.getElementById("edit_pic_maintenance").value
            );

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: formData,
                    redirect: "follow",
                });

                const result = await response.json();

                if (result.status === "success") {
                    showAlert("✅ Data berhasil diupdate!", "success");
                    closeModal("modalEdit");
                    loadBreakdownData();
                } else {
                    showAlert("❌ " + result.message, "error");
                }
            } catch (error) {
                console.error("Error updating:", error);
                showAlert("❌ Gagal update data: " + error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // ========================================
        // DELETE DATA
        // ========================================
        async function deleteData(noLkm) {
            if (
                !confirm(
                    `Apakah Anda yakin ingin menghapus data dengan No LKM: ${noLkm}?\n\nTindakan ini tidak dapat dibatalkan.`
                )
            ) {
                return;
            }

            const formData = new URLSearchParams();
            formData.append("action", "deleteBreakdown");
            formData.append("no_lkm", noLkm);

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: formData,
                    redirect: "follow",
                });

                const result = await response.json();

                if (result.status === "success") {
                    showAlert("✅ Data berhasil dihapus!", "success");
                    loadBreakdownData();
                } else {
                    showAlert("❌ " + result.message, "error");
                }
            } catch (error) {
                console.error("Error deleting:", error);
                showAlert("❌ Gagal hapus data: " + error.message, "error");
            }
        }

        // ========================================
        // EXPORT TO EXCEL
        // ========================================
        function exportToExcel() {
            if (!filteredBreakdownData || filteredBreakdownData.length === 0) {
                showAlert("⚠️ Tidak ada data untuk diekspor", "error");
                return;
            }

            let csv =
                "No LKM,ID Mesin,Nama Mesin,Tanggal Breakdown,Jam Breakdown,Tanggal Mulai Perbaikan,Jam Mulai Perbaikan,Tanggal Selesai Perbaikan,Jam Selesai Perbaikan,Problem Mesin,Penyebab Breakdown,Tindakan Perbaikan,PIC Maintenance,Status,Repair Time (jam),Total Downtime (jam)\n";

            filteredBreakdownData.forEach((row) => {
                csv += `"${row.no_lkm || ""}","${row.id_mesin || ""}","${row.nama_mesin || ""
                    }","${formatDate(row.tanggal_breakdown)}","${row.jam_breakdown || ""
                    }","${formatDate(row.tanggal_mulai_perbaikan)}","${row.jam_mulai_perbaikan || ""
                    }","${formatDate(row.tanggal_selesai_perbaikan)}","${row.jam_selesai_perbaikan || ""
                    }","${(row.problem_mesin || "").replace(/"/g, '""')}","${(
                        row.penyebab_breakdown || ""
                    ).replace(/"/g, '""')}","${(row.tindakan_perbaikan || "").replace(
                        /"/g,
                        '""'
                    )}","${row.pic_maintenance || ""}","${row.status_breakdown || ""
                    }","${formatNumber(row.repair_time)}","${formatNumber(
                        row.total_downtime
                    )}"\n`;
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);

            link.setAttribute("href", url);
            link.setAttribute(
                "download",
                `breakdown_data_${formatDateForFilename(new Date())}.csv`
            );
            link.style.visibility = "hidden";

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert("✅ Data berhasil diekspor!", "success");
        }

        // ========================================
        // MODAL FUNCTIONS
        // ========================================
        function openModal(modalId) {
            document.getElementById(modalId).style.display = "block";
            document.body.style.overflow = "hidden";
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
            document.body.style.overflow = "auto";
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function formatDate(dateString) {
            if (!dateString) return "-";
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString("id-ID", {
                day: "2-digit",
                month: "short",
                year: "numeric",
            });
        }

        function formatDateForFilename(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}${m}${d}`;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return "-";
            return parseFloat(num).toFixed(2);
        }

        function truncateText(text, maxLength) {
            if (!text) return "-";
            return text.length > maxLength
                ? text.substring(0, maxLength) + "..."
                : text;
        }

        function showAlert(message, type) {
            const container = document.getElementById("alertContainer");
            const alertClass = type === "success" ? "alert-success" : "alert-error";

            const alertDiv = document.createElement("div");
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = message;

            container.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.animation =
                    "slideUp 200ms cubic-bezier(0.4, 0, 0.2, 1)";
                setTimeout(() => alertDiv.remove(), 200);
            }, 5000);
        }

        const style = document.createElement("style");
        style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }
`;
        document.head.appendChild(style);
    </script>
</body>

</html>