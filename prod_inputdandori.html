<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Data Dandori - VCB Dandori System</title>
    <link rel="stylesheet" href="assets/style/style_input_dandori.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="8" fill="white"/>
                            <path d="M16 8L8 12V20L16 24L24 20V12L16 8Z" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M16 16L8 12M16 16L24 12M16 16V24" stroke="black" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>VCB DANDORI</h1>
                        <p>Monitoring System</p>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="prod_inputdandori.html" class="nav-item active">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 3L3 7V13L10 17L17 13V7L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                    </svg>
                    <span>Input Data Dandori</span>
                </a>
                <a href="prod_vcbdandori.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="8" width="4" height="9" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="8" y="3" width="4" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        <rect x="13" y="10" width="4" height="7" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="data_dandori.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M3 8H17M8 3V17" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    <span>Data Dandori</span>
                </a>
                <a href="index.html" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 17H16C16.5523 17 17 16.5523 17 16V4C17 3.44772 16.5523 3 16 3H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M8 13L3 10M3 10L8 7M3 10H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Kembali ke Menu</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <h2>Input Data Dandori</h2>
                    <p>Form pengisian data dandori activity untuk monitoring waktu dan status</p>
                </div>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Form Container -->
            <div class="form-container">
                <form id="dandoriForm">
                    <!-- Section: General Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>General Information</h3>
                            <p>Informasi umum aktivitas dandori</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="tanggal" class="field-label required">
                                    Tanggal
                                </label>
                                <input 
                                    type="date" 
                                    id="tanggal" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                            <div class="form-field">
                                <label for="pic_dandori" class="field-label required">
                                    PIC Name
                                </label>
                                <input 
                                    type="text" 
                                    id="pic_dandori" 
                                    class="field-input" 
                                    placeholder="Masukkan nama PIC"
                                    required
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Section: Machine & Part -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Machine & Part</h3>
                            <p>Pilih mesin dan part yang akan di-dandori</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="mesin_search" class="field-label required">
                                    Machine
                                </label>
                                <div class="searchable-dropdown" id="mesinDropdown">
                                    <div class="search-input-wrapper">
                                        <input 
                                            type="text" 
                                            id="mesin_search" 
                                            class="field-input searchable-input" 
                                            placeholder="Ketik untuk mencari mesin..."
                                            autocomplete="off"
                                            required
                                        >
                                        <svg class="search-icon" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="8" cy="8" r="5" stroke="currentColor" stroke-width="1.5"/>
                                            <path d="M12 12L16 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-list" id="mesinList"></div>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="part_search" class="field-label required">
                                    Part Name
                                </label>
                                <div class="searchable-dropdown" id="partDropdown">
                                    <div class="search-input-wrapper">
                                        <input 
                                            type="text" 
                                            id="part_search" 
                                            class="field-input searchable-input" 
                                            placeholder="Ketik untuk mencari part..."
                                            autocomplete="off"
                                            required
                                        >
                                        <svg class="search-icon" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="8" cy="8" r="5" stroke="currentColor" stroke-width="1.5"/>
                                            <path d="M12 12L16 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-list" id="partList"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Display -->
                        <div class="info-box" id="mesinPartInfo">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Line</span>
                                    <span class="info-value" id="displayLine">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Standard Time</span>
                                    <span class="info-value" id="displayStandard">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Part Number</span>
                                    <span class="info-value" id="displayPartNo">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Process ID</span>
                                    <span class="info-value" id="displayIdProses">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Dandori Time -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Dandori Time</h3>
                            <p>Waktu mulai dan selesai aktivitas dandori</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="jam_mulai" class="field-label required">
                                    Start Time
                                </label>
                                <input 
                                    type="time" 
                                    id="jam_mulai" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                            <div class="form-field">
                                <label for="jam_selesai" class="field-label required">
                                    End Time
                                </label>
                                <input 
                                    type="time" 
                                    id="jam_selesai" 
                                    class="field-input" 
                                    required
                                >
                            </div>
                        </div>

                        <!-- Duration Display -->
                        <div class="info-box duration-box" id="waktuInfo">
                            <div class="duration-display">
                                <div class="duration-item">
                                    <span class="duration-label">Duration</span>
                                    <span class="duration-value" id="displayDurasi">-</span>
                                </div>
                                <div class="duration-divider"></div>
                                <div class="duration-item">
                                    <span class="duration-label">Status</span>
                                    <span id="displayStatus">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Problem Notes -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>Problem Notes</h3>
                            <p>Catatan kendala atau masalah (opsional)</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-field full-width">
                                <label for="problem_dandori" class="field-label">
                                    Description
                                    <span class="optional-label">(Optional)</span>
                                </label>
                                <textarea 
                                    id="problem_dandori" 
                                    class="field-textarea" 
                                    rows="4"
                                    placeholder="Deskripsikan kendala atau masalah yang terjadi..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- Cancel Checkbox -->
                        <div class="checkbox-wrapper">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isCancel" class="field-checkbox">
                                <svg class="checkbox-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M7 10L9 12L13 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span class="checkbox-text">Cancel this dandori activity</span>
                            </label>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="resetForm()">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 9C2 5.13401 5.13401 2 9 2C12.866 2 16 5.13401 16 9C16 12.866 12.866 16 9 16C5.13401 16 2 12.866 2 9Z" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M9 5V9L11.5 11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            Reset Form
                        </button>
                        <button type="submit" class="btn-primary" id="btnSubmit">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 9L9 15L3 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 3V15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            Simpan Data
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxEJ2R8WF2iKGjEM9fOKhwlXxquCUIZ9bzmvTtdrALw848aj-DCXIJUAQs95Zb60rJY/exec';

        let masterMesin = [];
        let masterDies = [];
        let selectedMesin = null;
        let selectedPart = null;

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setDefaultDate();
            setupEventListeners();
            loadMasterData();
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').value = today;
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        function setupEventListeners() {
            document.getElementById('dandoriForm').addEventListener('submit', handleFormSubmit);
            
            const mesinSearch = document.getElementById('mesin_search');
            const partSearch = document.getElementById('part_search');
            
            mesinSearch.addEventListener('input', (e) => filterDropdown(e.target.value, 'mesin'));
            mesinSearch.addEventListener('focus', () => showDropdown('mesin'));
            
            partSearch.addEventListener('input', (e) => filterDropdown(e.target.value, 'part'));
            partSearch.addEventListener('focus', () => showDropdown('part'));
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.searchable-dropdown')) {
                    hideAllDropdowns();
                }
            });
            
            document.getElementById('jam_mulai').addEventListener('change', calculateDuration);
            document.getElementById('jam_selesai').addEventListener('change', calculateDuration);
            document.getElementById('isCancel').addEventListener('change', calculateDuration);
        }

        // ========================================
        // LOAD MASTER DATA
        // ========================================
        async function loadMasterData() {
            try {
                const mesinResponse = await fetch(`${API_URL}?action=getMasterMesin&_=${Date.now()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                const mesinData = await mesinResponse.json();
                
                if (mesinData.success) {
                    masterMesin = mesinData.data;
                    renderMesinDropdown(masterMesin);
                }

                const diesResponse = await fetch(`${API_URL}?action=getMasterDies&_=${Date.now()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                const diesData = await diesResponse.json();
                
                if (diesData.success) {
                    masterDies = diesData.data;
                    renderPartDropdown(masterDies);
                }
            } catch (error) {
                console.error('Error loading master data:', error);
                showAlert('Gagal memuat data master. Periksa koneksi dan URL deployment.', 'error');
            }
        }

        // ========================================
        // RENDER DROPDOWNS
        // ========================================
        function renderMesinDropdown(data) {
            const list = document.getElementById('mesinList');
            
            if (data.length === 0) {
                list.innerHTML = '<div class="dropdown-empty">Tidak ada mesin ditemukan</div>';
                return;
            }
            
            list.innerHTML = data.map(mesin => `
                <div class="dropdown-item" data-value="${mesin.nama_mesin}" data-mesin='${JSON.stringify(mesin)}'>
                    <div class="dropdown-item-title">${mesin.nama_mesin}</div>
                    <div class="dropdown-item-subtitle">Line: ${mesin.line} | Standard: ${mesin.standard_dandori} min</div>
                </div>
            `).join('');
            
            list.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectMesin(item));
            });
        }

        function renderPartDropdown(data) {
            const list = document.getElementById('partList');
            
            if (data.length === 0) {
                list.innerHTML = '<div class="dropdown-empty">Tidak ada part ditemukan</div>';
                return;
            }
            
            list.innerHTML = data.map(part => `
                <div class="dropdown-item" data-value="${part.part_name}" data-part='${JSON.stringify(part)}'>
                    <div class="dropdown-item-title">${part.part_name}</div>
                    <div class="dropdown-item-subtitle">Part No: ${part.part_no} | Process: ${part.nama_proses}</div>
                </div>
            `).join('');
            
            list.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectPart(item));
            });
        }

        // ========================================
        // DROPDOWN FUNCTIONS
        // ========================================
        function filterDropdown(query, type) {
            const data = type === 'mesin' ? masterMesin : masterDies;
            const searchField = type === 'mesin' ? 'nama_mesin' : 'part_name';
            
            const filtered = data.filter(item => 
                item[searchField].toLowerCase().includes(query.toLowerCase())
            );
            
            if (type === 'mesin') {
                renderMesinDropdown(filtered);
            } else {
                renderPartDropdown(filtered);
            }
            
            showDropdown(type);
        }

        function showDropdown(type) {
            const listId = type === 'mesin' ? 'mesinList' : 'partList';
            document.getElementById(listId).classList.add('show');
        }

        function hideAllDropdowns() {
            document.getElementById('mesinList').classList.remove('show');
            document.getElementById('partList').classList.remove('show');
        }

        function selectMesin(item) {
            const mesinData = JSON.parse(item.dataset.mesin);
            selectedMesin = mesinData;
            
            document.getElementById('mesin_search').value = mesinData.nama_mesin;
            displayMesinInfo();
            calculateDuration();
            hideAllDropdowns();
        }

        function selectPart(item) {
            const partData = JSON.parse(item.dataset.part);
            selectedPart = partData;
            
            document.getElementById('part_search').value = partData.part_name;
            displayPartInfo();
            hideAllDropdowns();
        }

        // ========================================
        // DISPLAY INFO
        // ========================================
        function displayMesinInfo() {
            document.getElementById('displayLine').textContent = selectedMesin.line;
            document.getElementById('displayStandard').textContent = `${selectedMesin.standard_dandori} min`;
            document.getElementById('mesinPartInfo').classList.add('show');
        }

        function displayPartInfo() {
            document.getElementById('displayPartNo').textContent = selectedPart.part_no;
            document.getElementById('displayIdProses').textContent = selectedPart.id_proses;
        }

        // ========================================
        // CALCULATE DURATION
        // ========================================
        function calculateDuration() {
            const jamMulai = document.getElementById('jam_mulai').value;
            const jamSelesai = document.getElementById('jam_selesai').value;
            const isCancel = document.getElementById('isCancel').checked;

            if (!jamMulai || !jamSelesai || !selectedMesin) return;

            const startTime = new Date(`1970-01-01T${jamMulai}`);
            const endTime = new Date(`1970-01-01T${jamSelesai}`);
            const durationMinutes = Math.round((endTime - startTime) / (1000 * 60));

            if (durationMinutes <= 0) {
                showAlert('Waktu selesai harus lebih besar dari waktu mulai', 'error');
                return;
            }

            document.getElementById('displayDurasi').textContent = `${durationMinutes} min`;

            const status = determineStatus(durationMinutes, selectedMesin.standard_dandori, isCancel);
            displayStatus(status);

            document.getElementById('waktuInfo').classList.add('show');
        }

        function determineStatus(duration, standard, isCancel) {
            if (isCancel) {
                return { text: 'Cancel', class: 'status-cancel' };
            }
            if (duration <= standard) {
                return { text: 'On Time', class: 'status-ontime' };
            }
            const delay = duration - standard;
            return { text: `Delay (+${delay} min)`, class: 'status-delay' };
        }

        function displayStatus(status) {
            document.getElementById('displayStatus').innerHTML = `
                <span class="status-badge ${status.class}">${status.text}</span>
            `;
        }

        // ========================================
        // FORM SUBMISSION
        // ========================================
        async function handleFormSubmit(e) {
            e.preventDefault();

            if (!selectedMesin || !selectedPart) {
                showAlert('Silakan pilih mesin dan part terlebih dahulu', 'error');
                return;
            }

            const btn = document.getElementById('btnSubmit');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: spin 1s linear infinite;">
                    <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
                </svg>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
                Menyimpan...
            `;

            const formData = new URLSearchParams();
            formData.append('action', 'addDataDandori');
            formData.append('tanggal', document.getElementById('tanggal').value);
            formData.append('mesin', selectedMesin.nama_mesin);
            formData.append('part_no', selectedPart.part_no);
            formData.append('part_name', selectedPart.part_name);
            formData.append('id_proses', selectedPart.id_proses);
            formData.append('nama_proses', selectedPart.nama_proses);
            formData.append('jam_mulai_dandori', document.getElementById('jam_mulai').value);
            formData.append('jam_selesai_dandori', document.getElementById('jam_selesai').value);
            formData.append('standard_dandori', selectedMesin.standard_dandori);
            formData.append('problem_dandori', document.getElementById('problem_dandori').value.trim());
            formData.append('pic_dandori', document.getElementById('pic_dandori').value.trim());
            formData.append('isCancel', document.getElementById('isCancel').checked);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow'
                });

                const result = await response.json();

                if (result.success) {
                    const successMessage = `
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="font-weight: 600; font-size: 1rem;">✅ Data berhasil disimpan!</div>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.875rem;">
                                <span style="font-weight: 500;">Mesin:</span>
                                <span>${selectedMesin.nama_mesin}</span>
                                <span style="font-weight: 500;">Part:</span>
                                <span>${selectedPart.part_name}</span>
                                <span style="font-weight: 500;">Duration:</span>
                                <span>${result.data.selisih} minutes</span>
                                <span style="font-weight: 500;">Status:</span>
                                <span style="color: ${result.data.status === 'On Time' ? '#10b981' : '#ef4444'};">${result.data.status}</span>
                            </div>
                        </div>
                    `;
                    showAlert(successMessage, 'success');
                    
                    resetForm();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showAlert('❌ ' + (result.error || 'Gagal menyimpan data'), 'error');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showAlert('❌ Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = message;
            
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideUp 200ms cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => alertDiv.remove(), 200);
            }, 5000);
        }

        function resetForm() {
            if (confirm('Apakah Anda yakin ingin mereset form? Semua data yang belum disimpan akan hilang.')) {
                document.getElementById('dandoriForm').reset();
                setDefaultDate();
                document.getElementById('mesin_search').value = '';
                document.getElementById('part_search').value = '';
                document.getElementById('mesinPartInfo').classList.remove('show');
                document.getElementById('waktuInfo').classList.remove('show');
                selectedMesin = null;
                selectedPart = null;
                hideAllDropdowns();
                document.getElementById('alertContainer').innerHTML = '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-10px);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>